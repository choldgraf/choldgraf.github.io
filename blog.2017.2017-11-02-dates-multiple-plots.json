{"kind":"Notebook","sha256":"2b581250bec5b8dec147b3ecdac24fc78b567150196664b3febe34635bedcc75","slug":"blog.2017.2017-11-02-dates-multiple-plots","location":"/blog/2017/2017-11-02-dates_multiple_plots.ipynb","dependencies":[],"frontmatter":{"title":"Combining dates with analysis visualization in python","tags":["python","open science"],"date":"2017-11-02","kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"content_includes_title":false,"authors":[{"id":"chris","nameParsed":{"literal":"Chris Holdgraf","given":"Chris","family":"Holdgraf"},"name":"Chris Holdgraf","orcid":"0000-0002-2391-0678","affiliations":["affiliations-myst-generated-uid-0","affiliations-myst-generated-uid-1"],"twitter":"choldgraf","github":"choldgraf","url":"https://chrisholdgraf.com"}],"github":"https://github.com/choldgraf/choldgraf.github.io","affiliations":[{"name":"2i2c","url":"https://2i2c.org","id":"affiliations-myst-generated-uid-0"},{"name":"Project Jupyter","url":"https://jupyter.org","id":"affiliations-myst-generated-uid-1"}],"numbering":{"title":{"offset":2}},"edit_url":"https://github.com/choldgraf/choldgraf.github.io/blob/main/blog/2017/2017-11-02-dates_multiple_plots.ipynb","exports":[{"format":"ipynb","filename":"2017-11-02-dates_multiple_plots.ipynb","url":"/build/2017-11-02-dates_mul-a7fc394903be069e7979fc060b61fb06.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"children":[{"type":"text","value":"Sometimes you want to do two things:","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"wbNA6ZgNdb"}],"key":"cKKUbzIONZ"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":30,"column":1},"end":{"line":32,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"children":[{"type":"text","value":"Plot a timeseries that handles datetimes in a clever way (e.g., with Pandas or Matplotlib)","position":{"start":{"line":30,"column":1},"end":{"line":30,"column":1}},"key":"gJZ6e8u4fI"}],"key":"WcagRG9x3x"},{"type":"listItem","spread":true,"position":{"start":{"line":31,"column":1},"end":{"line":32,"column":1}},"children":[{"type":"text","value":"Plot some kind of analysis on top of that timeseries.","position":{"start":{"line":31,"column":1},"end":{"line":31,"column":1}},"key":"ZUkUcLQJD0"}],"key":"TYnIZ4rEvl"}],"key":"udiwN79sbM"},{"type":"paragraph","position":{"start":{"line":33,"column":1},"end":{"line":33,"column":1}},"children":[{"type":"text","value":"Sounds simple right? It’s not.","position":{"start":{"line":33,"column":1},"end":{"line":33,"column":1}},"key":"DjdluniGdA"}],"key":"dZaJjgqeRj"},{"type":"paragraph","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"children":[{"type":"text","value":"The reason for this is that plotting libraries don’t ","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"EspmLKiOmm"},{"type":"emphasis","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"children":[{"type":"text","value":"really","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"QFcZavjL4k"}],"key":"tWzgPS879f"},{"type":"text","value":" plot human-readable dates, they convert dates to numbers, then change the xtick labels so that they’re human readable. This means that if you want to plot something ","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"exAuid5tiH"},{"type":"emphasis","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"children":[{"type":"text","value":"on top","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"IvCeLZXYfP"}],"key":"vezo5NBNfb"},{"type":"text","value":" of dates, it’s quite confusing.","position":{"start":{"line":35,"column":1},"end":{"line":35,"column":1}},"key":"EjjAuURzGn"}],"key":"CLxhWscxFS"},{"type":"paragraph","position":{"start":{"line":37,"column":1},"end":{"line":38,"column":1}},"children":[{"type":"text","value":"To demonstrate this, let’s grab the latest stock market prices for a couple companies and\nfit regression lines to them...","position":{"start":{"line":37,"column":1},"end":{"line":37,"column":1}},"key":"nIRS0noGeW"}],"key":"b7HIyPR8zo"}],"key":"qYjirhBvOO"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"import pandas as pd\nimport seaborn as sns\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport pandas_datareader.data as web\nimport datetime\nplt.ion()","key":"CacMqR5w3P"},{"type":"output","id":"rLF-LqrARuth-BYTO04F1","data":[],"key":"XcRrs3E1qU"}],"key":"EkbmGHTd2k"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"start = datetime.datetime(2010, 1, 1)\nend = datetime.datetime(2017, 10, 31)\ncompanies = ['AAPL', 'IBM']\ndata = web.DataReader(companies, 'google', start, end)","key":"uATnpg30iZ"},{"type":"output","id":"3SknrlMfDCeudh3DD0C0h","data":[],"key":"V9dY57teso"}],"key":"bocA15UUIz"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"def prep_data(data):\n    data = data.sort_index()\n    data = data.resample('D').mean().copy()\n    data = data.reset_index().dropna()\n    data['High'] -= data['High'].min()\n    return data","key":"SRC5JaCffQ"},{"type":"output","id":"GKSdOLCHu3zKnmBiFdkzT","data":[],"key":"DVUpHcT4rf"}],"key":"ufiGBoN5Fo"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"fig, ax = plt.subplots(figsize=(12, 6))\nfor company in companies:\n    this_data = prep_data(data.loc[:, :, company])\n    this_data.plot.line('Date', 'High', ax=ax, label=company)","key":"XWIdzY6NER"},{"type":"output","id":"ys1wNWEl27_eP04evM9F_","data":[{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"e985d9b4ce786b197fc2eb3a23f0ea9d","path":"/build/e985d9b4ce786b197fc2eb3a23f0ea9d.png"},"text/plain":{"content":"&ltmatplotlib.figure.Figure at 0x7f5c24414390&gt","content_type":"text/plain"}}}],"key":"SvQUESUXa5"}],"key":"GyUKW4XSkx"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Let’s say we want to fit a regression line to each stock, should be simple, right?","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hBN6cZdGqF"}],"key":"uSURUqbEYv"}],"key":"LqTrQj3VBv"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"fig, ax = plt.subplots(figsize=(12, 6))\nfor company in companies:\n    this_data = prep_data(data.loc[:, :, company])\n    this_data.plot.line('Date', 'High', ax=ax, label=company)\n    try:\n        sns.regplot('Date', 'High', data=this_data.query('Date > \"2017-04-01\" and Date < \"2017-09-01\"'))\n    except Exception as ee:\n        print('***ERROR: ',  ee, '***')","key":"bAeyVDjEQA"},{"type":"output","id":"L-A7ds3zp8UKJZO1NAkOU","data":[{"name":"stdout","output_type":"stream","text":"***ERROR:  reduction operation 'mean' not allowed for this dtype ***\n***ERROR:  reduction operation 'mean' not allowed for this dtype ***\n"},{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"e985d9b4ce786b197fc2eb3a23f0ea9d","path":"/build/e985d9b4ce786b197fc2eb3a23f0ea9d.png"},"text/plain":{"content":"&ltmatplotlib.figure.Figure at 0x7f5c21052128&gt","content_type":"text/plain"}}}],"key":"c9cmzsm3c1"}],"key":"PWIHSnBPc5"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We got an error! That’s because seaborn was treating the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ZPvT2p8wG9"},{"type":"inlineCode","value":"Date","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"dshhmwHkJk"},{"type":"text","value":" column as a number, when in fact it was a datetime object.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Zr3TPwWzkV"}],"key":"JUZt0E6Ik5"},{"type":"heading","depth":2,"position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"How do we fix this?","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ECCfEWsVXk"}],"identifier":"how-do-we-fix-this","label":"How do we fix this?","html_id":"how-do-we-fix-this","implicit":true,"key":"eIY78PlX5d"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"To fix this, we need to convert the datetime labels to their ordinal (numeric) representation. There are a number of ways to convert dates to numbers. Fortunately, Matplotlib has a convenience function to convert datetime objects to their numeric representation.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"MhOe3dH2HJ"}],"key":"dMeOuu4SXs"}],"key":"xZcVTL4NT2"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"from matplotlib.dates import date2num\ndate2num(this_data['Date'][0])","key":"XftjAOFGFi"},{"type":"output","id":"HCJEcobmGSqvRlZ3eDAmD","data":[{"output_type":"execute_result","execution_count":6,"metadata":{},"data":{"text/plain":{"content":"736270.0","content_type":"text/plain"}}}],"key":"ABe6Za8kMo"}],"key":"rkRz3Xuhqc"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"# Here's how we convert the Period object to a date:\nsample_ordinal = this_data['Date'].map(lambda a: date2num(a))\nsample_ordinal.head()","key":"dJzGh4krhz"},{"type":"output","id":"ppv2CFaoljbdu2OdtnzB8","data":[{"output_type":"execute_result","execution_count":7,"metadata":{},"data":{"text/plain":{"content":"0    736270.0\n1    736271.0\n2    736272.0\n5    736275.0\n6    736276.0\nName: Date, dtype: float64","content_type":"text/plain"}}}],"key":"YmbUz8Vqbh"}],"key":"NVbzdIkCQp"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Below we’ll insert this into our plotting code to see what happens.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"EdLHWmrVeW"}],"key":"cL4wgJsDb1"}],"key":"Tbhe5DFP1F"},{"type":"block","kind":"notebook-code","data":{},"children":[{"type":"code","lang":"python","executable":true,"value":"fig, ax = plt.subplots(figsize=(12, 6))\nfor ii, company in enumerate(companies):\n    this_data = prep_data(data.loc[:, :, company])\n    this_data['Date_Ord'] = this_data['Date'].map(lambda a: date2num(a))\n    this_data.plot.line('Date', 'High', ax=ax, label=company, color='C{}'.format(ii))\n    sns.regplot('Date_Ord', 'High', data=this_data.query('Date > \"2017-04-01\" and Date < \"2017-09-01\"'),\n                truncate=True, color='C{}'.format(ii))","key":"wFW1dcBn6L"},{"type":"output","id":"Byx57RW_HdlUfCs6i_Goj","data":[{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"ba9c46946802beb304b2fa8f0e5388cc","path":"/build/ba9c46946802beb304b2fa8f0e5388cc.png"},"text/plain":{"content":"&ltmatplotlib.figure.Figure at 0x7f5c210b0048&gt","content_type":"text/plain"}}}],"key":"mvjnbbOfyL"}],"key":"FMPVcZzN9J"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"And there you have it - mixed datetime visualization across multiple libraries.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"anaZUU2j6R"}],"key":"u2eV1BnXbf"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Note that this is ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"XGd37MuIYR"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"not","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"WPtDzpmwHi"}],"key":"lRVkuU2Yh9"},{"type":"text","value":" the same thing as plotting an actual\ndatetime object, we’re plotting a datetime ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"oPCfKfYGuZ"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"period","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"kL5IIHVuwY"}],"key":"lhcFT5VdsU"},{"type":"text","value":" above, which is the only way I’ve figure\nout how to make this work.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"XtNGdivGKt"}],"key":"zTseKT0upg"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Of course, this is all unnecessarily complicated, and hopefully we’ll see some patches\nthat ease this in the future. But in the meantime you can refer to the above method\nfor your datetime viz needs.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"VSm18OQKC6"}],"key":"jSQ6Ty5k3l"}],"key":"Inu3gM7Gje"}],"key":"U3j7yVCaZq"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Dates in python","url":"/blog/2017/2017-03-16-dates-in-python","group":"2017"},"next":{"title":"The beauty of computational efficiency","url":"/blog/2016/2016-07-02-fft-time","group":"2016"}}},"domain":"http://localhost:3000"}