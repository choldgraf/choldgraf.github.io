{"version":1,"kind":"Article","sha256":"4e57dbf4ec3f239e62fb9869c0811f0e71b04c3f6cb2472d94e75edc202dea80","slug":"blog.2018.circlci-github","location":"/blog/2018/circlci-github.md","dependencies":[],"frontmatter":{"title":"Automatically mirror a github repository with CircleCI","tags":["productivity","CICD"],"date":"2018-12-18","content_includes_title":false,"authors":[{"id":"chris","nameParsed":{"literal":"Chris Holdgraf","given":"Chris","family":"Holdgraf"},"name":"Chris Holdgraf","orcid":"0000-0002-2391-0678","affiliations":["affiliations-myst-generated-uid-0","affiliations-myst-generated-uid-1"],"twitter":"choldgraf","github":"choldgraf","url":"https://chrisholdgraf.com"}],"github":"https://github.com/choldgraf/choldgraf.github.io","affiliations":[{"name":"2i2c","url":"https://2i2c.org","id":"affiliations-myst-generated-uid-0"},{"name":"Project Jupyter","url":"https://jupyter.org","id":"affiliations-myst-generated-uid-1"}],"abbreviations":{"LF":"The Linux Foundation","JF":"The Jupyter Foundation","JEC":"Jupyter Executive Council","JFB":"The Jupyter Foundation Board","SSC":"Software Steering Council"},"numbering":{"title":{"offset":2}},"edit_url":"https://github.com/choldgraf/choldgraf.github.io/blob/main/blog/2018/circlci-github.md","thumbnail":"/build/circleci-mirror-depl-68c4c4c813d7421a843c733b67e58a10.png","exports":[{"format":"md","filename":"circlci-github.md","url":"/build/circlci-github-337e4e2f663e1de8262bc9b3b59c4f1c.md"}]},"mdast":{"type":"root","children":[{"type":"block","children":[{"type":"blockquote","position":{"start":{"line":12,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":12,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"tl;dr: you can automatically mirror the contents of one repository to another by\nusing CI/CD services like CircleCI. This post shows you one way to do it using\nsecrets that let you push to a GitHub repository from a CircleCI process.","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"B6wK7CtFuz"}],"key":"odCpH6Hs12"}],"key":"zOX1czcXJk"},{"type":"paragraph","position":{"start":{"line":16,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"text","value":"We recently ran into an issue with the Data 8 course where we needed to mirror\none GitHub site to another. In short, the textbook is built with a tool called\n","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"ITxXmf3kgt"},{"type":"link","url":"https://chrisholdgraf.com/jupyter-book/intro.html","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"jupyter-book","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"wh6dkLCze8"}],"urlSource":"https://chrisholdgraf.com/jupyter-book/intro.html","key":"GmPzqeEHga"},{"type":"text","value":", and we use ","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"vs1DMzHcaj"},{"type":"link","url":"https://pages.github.com/","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"github-pages","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"RVvA29AkzL"}],"urlSource":"https://pages.github.com/","key":"FojS1DE9wi"},{"type":"text","value":"\nto host the content at ","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"CQYXfCf7Ye"},{"type":"link","url":"https://inferentialthinking.com","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"inferentialthinking​.com","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"Fpq9FCauYe"}],"urlSource":"https://inferentialthinking.com","key":"o8GEHsNQFt"},{"type":"text","value":".\nFor ","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"hd0TI4MTe4"},{"type":"link","url":"https://help.github.com/articles/custom-domain-redirects-for-github-pages-sites/","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"weird URL-naming reasons","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"xXgS449ZMW"}],"urlSource":"https://help.github.com/articles/custom-domain-redirects-for-github-pages-sites/","key":"hX0v4vtGTp"},{"type":"text","value":",\nwe had to create ","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"QdWpU2ZKq5"},{"type":"link","url":"https://github.com/inferentialthinking/inferentialthinking.github.io","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"a second organization","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"ePiSlMJFDp"}],"urlSource":"https://github.com/inferentialthinking/inferentialthinking.github.io","error":true,"key":"bb0prG2gyY"},{"type":"text","value":"\nto host the actual site. This introduced the complexity that any time the textbook\nhad to be updated, we did so in ","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"IZkLwrAqI8"},{"type":"emphasis","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"two","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"bvl9A24C1n"}],"key":"WC6qJi9tdN"},{"type":"text","value":" different places. The raw textbook content\nis hosted at ","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"jMRwSWsH44"},{"type":"link","url":"https://github.com/data-8/textbook","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"https://​github​.com​/data​-8​/textbook","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"uE3Xu4uuIy"}],"urlSource":"https://github.com/data-8/textbook","error":true,"key":"IV5VrflNRs"},{"type":"text","value":", and the version hosted online is\nat ","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"kPwk44gRW6"},{"type":"link","url":"https://github.com/inferentialthinking/inferentialthinking.github.io","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"https://​github​.com​/inferentialthinking​/inferentialthinking​.github​.io","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"edfxvVxcsv"}],"urlSource":"https://github.com/inferentialthinking/inferentialthinking.github.io","error":true,"key":"aFSsLwQTZW"},{"type":"text","value":".","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"EyuiAlY942"}],"key":"mOrCcuvdsy"},{"type":"paragraph","position":{"start":{"line":27,"column":1},"end":{"line":30,"column":1}},"children":[{"type":"text","value":"This is a pain, because now a person has to take several actions across two repositories\nany time we update the textbook content. But not anymore! Now we use CirleCI to automatically deploy an update to\n","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"g01L2Mnmgm"},{"type":"link","url":"http://inferentialthinking.com","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"text","value":"inferentialthinking​.com","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"w7KeH62dK0"}],"urlSource":"http://inferentialthinking.com","key":"lLYcXupe08"},{"type":"text","value":" any time a change is made to data-8/textbook. Here\nare the steps to do it.","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"xYRasjEpAg"}],"key":"Jj0Bu7X529"},{"type":"paragraph","position":{"start":{"line":32,"column":1},"end":{"line":36,"column":1}},"children":[{"type":"text","value":"In these steps, we’ll have two repositories, one with the “primary” repository\nwe want to keep, and one with the “mirror” repository that should always contain\nexactly the content of the “primary” repo. I’ll call these “primary” and “mirror”\nrepos from here on out (no, I won’t call them master and slave but that’s a whole\nother conversation).","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"qtH9vHiBxt"}],"key":"qxT5ksQa4B"},{"type":"heading","depth":2,"position":{"start":{"line":38,"column":1},"end":{"line":38,"column":1}},"children":[{"type":"text","value":"What we want to do","position":{"start":{"line":38,"column":1},"end":{"line":38,"column":1}},"key":"VSOFtUutCF"}],"identifier":"what-we-want-to-do","label":"What we want to do","html_id":"what-we-want-to-do","implicit":true,"key":"pqklzgmLp4"},{"type":"paragraph","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"children":[{"type":"text","value":"Ultimately, we’d like the following thing to happen:","position":{"start":{"line":40,"column":1},"end":{"line":40,"column":1}},"key":"bKoWmPGPIx"}],"key":"XLOfxLSDYu"},{"type":"blockquote","position":{"start":{"line":42,"column":1},"end":{"line":43,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":42,"column":1},"end":{"line":43,"column":1}},"children":[{"type":"strong","position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"children":[{"type":"text","value":"Whenever a change is pushed to the “primary” repository, CircleCI should push\nthose changes to the “mirror” repository.","position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"key":"su7ICQ0ELh"}],"key":"MGf4rgQjk1"}],"key":"X7SSUK28j7"}],"key":"KaTEnxqPKe"},{"type":"paragraph","position":{"start":{"line":45,"column":1},"end":{"line":48,"column":1}},"children":[{"type":"text","value":"Since CircleCI already lets you run semi-arbitrary code, this is relatively\nstraightforward, with one big caveat: permissions. GitHub doesn’t let ","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"mFGvsuv86L"},{"type":"emphasis","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"children":[{"type":"text","value":"anybody","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"Crk5tejgdA"}],"key":"ACFDMRbGo8"},{"type":"text","value":"\npush to ","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"lkRxgVe37T"},{"type":"emphasis","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"children":[{"type":"text","value":"any","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"f0FUh5SNlY"}],"key":"gph4R68jvS"},{"type":"text","value":" repository, so we need some way to allow CircleCI to push to\nour mirror repository. That’s what these steps are all about.","position":{"start":{"line":45,"column":1},"end":{"line":45,"column":1}},"key":"RFsU97oEN8"}],"key":"KVASnbayGp"},{"type":"heading","depth":2,"position":{"start":{"line":50,"column":1},"end":{"line":50,"column":1}},"children":[{"type":"text","value":"Step 1: Create an SSH key for your mirror github repository","position":{"start":{"line":50,"column":1},"end":{"line":50,"column":1}},"key":"ToCBOZ13Te"}],"identifier":"step-1-create-an-ssh-key-for-your-mirror-github-repository","label":"Step 1: Create an SSH key for your mirror github repository","html_id":"step-1-create-an-ssh-key-for-your-mirror-github-repository","implicit":true,"key":"lW88HYdktm"},{"type":"paragraph","position":{"start":{"line":52,"column":1},"end":{"line":56,"column":1}},"children":[{"type":"text","value":"First off, we need to tell the mirror repository “you should let anyone with\nthese credentials push to the repo”. We’ll do this by creating a “deploy key”.\nThis is a SSH public/private key pair that, when combined, will allow anybody\nto push to your repository. ","position":{"start":{"line":52,"column":1},"end":{"line":52,"column":1}},"key":"dGaPnOcz1f"},{"type":"strong","position":{"start":{"line":52,"column":1},"end":{"line":52,"column":1}},"children":[{"type":"text","value":"If anybody has the private key, they have push access\nto your repo","position":{"start":{"line":52,"column":1},"end":{"line":52,"column":1}},"key":"eKopjwImS5"}],"key":"yypbCjWFdi"},{"type":"text","value":", so keep the private key safe!","position":{"start":{"line":52,"column":1},"end":{"line":52,"column":1}},"key":"RLBfo5YoRG"}],"key":"FRNZDHLTnv"},{"type":"paragraph","position":{"start":{"line":58,"column":1},"end":{"line":58,"column":1}},"children":[{"type":"text","value":"First, create a new public/private key pair with this command (in a *nix system):","position":{"start":{"line":58,"column":1},"end":{"line":58,"column":1}},"key":"Eny48MG78k"}],"key":"XnQggR43vH"},{"type":"code","lang":"","value":"ssh-keygen -f ~/key.txt","position":{"start":{"line":60,"column":1},"end":{"line":62,"column":1}},"key":"EK9ghK3Z1N"},{"type":"paragraph","position":{"start":{"line":64,"column":1},"end":{"line":64,"column":1}},"children":[{"type":"strong","position":{"start":{"line":64,"column":1},"end":{"line":64,"column":1}},"children":[{"type":"text","value":"when it asks for a passphrase, simply hit enter twice","position":{"start":{"line":64,"column":1},"end":{"line":64,"column":1}},"key":"ER1XhsluYR"}],"key":"XEz4IyYzet"},{"type":"text","value":". This makes the passphrase empty.","position":{"start":{"line":64,"column":1},"end":{"line":64,"column":1}},"key":"UfYqOSw6PG"}],"key":"GmJLTNrpGf"},{"type":"paragraph","position":{"start":{"line":66,"column":1},"end":{"line":66,"column":1}},"children":[{"type":"text","value":"This generates two files in your home directory:","position":{"start":{"line":66,"column":1},"end":{"line":66,"column":1}},"key":"ghhN7umZv6"}],"key":"Gj8p554uwe"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":68,"column":1},"end":{"line":70,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":68,"column":1},"end":{"line":68,"column":1}},"children":[{"type":"inlineCode","value":"key.txt","position":{"start":{"line":68,"column":1},"end":{"line":68,"column":1}},"key":"PyxEgBwtdN"},{"type":"text","value":" is your private key. You ","position":{"start":{"line":68,"column":1},"end":{"line":68,"column":1}},"key":"tBxzqn4fbf"},{"type":"strong","position":{"start":{"line":68,"column":1},"end":{"line":68,"column":1}},"children":[{"type":"text","value":"should not share this w/ others","position":{"start":{"line":68,"column":1},"end":{"line":68,"column":1}},"key":"TLjjA6DFIL"}],"key":"TKmvLSfISE"},{"type":"text","value":" unless you know what you’re doing.","position":{"start":{"line":68,"column":1},"end":{"line":68,"column":1}},"key":"LjPPs32vaY"}],"key":"fLnIaAzFHn"},{"type":"listItem","spread":true,"position":{"start":{"line":69,"column":1},"end":{"line":70,"column":1}},"children":[{"type":"inlineCode","value":"key.txt.pub","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"qQ4TxVtZ1U"},{"type":"text","value":" is your public key. You can share this w/ others.","position":{"start":{"line":69,"column":1},"end":{"line":69,"column":1}},"key":"UaRpZmH9RI"}],"key":"EeK2mjICw1"}],"key":"m00QhNXQ4R"},{"type":"heading","depth":2,"position":{"start":{"line":71,"column":1},"end":{"line":71,"column":1}},"children":[{"type":"text","value":"Step 2: Add this SSH key as a “deploy key” to your mirror repo","position":{"start":{"line":71,"column":1},"end":{"line":71,"column":1}},"key":"ajwfjRRbeW"}],"identifier":"step-2-add-this-ssh-key-as-a-deploy-key-to-your-mirror-repo","label":"Step 2: Add this SSH key as a “deploy key” to your mirror repo","html_id":"step-2-add-this-ssh-key-as-a-deploy-key-to-your-mirror-repo","implicit":true,"key":"VEkLnAJ4gb"},{"type":"paragraph","position":{"start":{"line":73,"column":1},"end":{"line":73,"column":1}},"children":[{"type":"text","value":"In your github repository, go to ","position":{"start":{"line":73,"column":1},"end":{"line":73,"column":1}},"key":"plSoHIP7iu"},{"type":"inlineCode","value":"settings -> deploy keys -> add deploy key","position":{"start":{"line":73,"column":1},"end":{"line":73,"column":1}},"key":"bnORJb0krO"},{"type":"text","value":". See the diagram below for the steps:","position":{"start":{"line":73,"column":1},"end":{"line":73,"column":1}},"key":"bF6OL6mm6v"}],"key":"Hr9RuUfs2O"},{"type":"image","url":"/build/circleci-mirror-depl-68c4c4c813d7421a843c733b67e58a10.png","position":{"start":{"line":75,"column":1},"end":{"line":75,"column":1}},"key":"sXClctjrUD","urlSource":"../../images/2018/circleci-mirror-deploy-key-ui.png"},{"type":"paragraph","position":{"start":{"line":77,"column":1},"end":{"line":78,"column":1}},"children":[{"type":"text","value":"When you click ","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"BYrRG4N7Jm"},{"type":"inlineCode","value":"add deploy key","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"T5Nmf3DldA"},{"type":"text","value":", it’ll open an interface for you to add the ","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"mS93YIaN5E"},{"type":"emphasis","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"children":[{"type":"text","value":"public","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"wv835kZcDU"}],"key":"RDmb06OagQ"},{"type":"text","value":" key for the\ndeployment permissions. Copy the text of your ","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"P2zfBu33lX"},{"type":"strong","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"children":[{"type":"text","value":"public key","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"fCyLcIZNeQ"}],"key":"zp2cblhJ3s"},{"type":"text","value":" (at ","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"iWa9ixHfd3"},{"type":"inlineCode","value":"~/key.txt.pub","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"DwMas7WffR"},{"type":"text","value":") and paste it in the window like so:","position":{"start":{"line":77,"column":1},"end":{"line":77,"column":1}},"key":"ahqOkhiHvg"}],"key":"tie1LtAcjg"},{"type":"image","url":"/build/circleci-deploy-key--2ef93b15f30d71da772caebc8407e66a.png","position":{"start":{"line":80,"column":1},"end":{"line":80,"column":1}},"key":"CmdOfzO1yZ","urlSource":"../../images/2018/circleci-deploy-key-ssh.png"},{"type":"paragraph","position":{"start":{"line":82,"column":1},"end":{"line":83,"column":1}},"children":[{"type":"text","value":"Remember, this is the ","position":{"start":{"line":82,"column":1},"end":{"line":82,"column":1}},"key":"qa3nfEdhhK"},{"type":"strong","position":{"start":{"line":82,"column":1},"end":{"line":82,"column":1}},"children":[{"type":"text","value":"public","position":{"start":{"line":82,"column":1},"end":{"line":82,"column":1}},"key":"c2CUq8sCzy"}],"key":"St7s9lR3Ks"},{"type":"text","value":" key for your repository. This means that anyone\nwith the ","position":{"start":{"line":82,"column":1},"end":{"line":82,"column":1}},"key":"gIyUg4INEy"},{"type":"strong","position":{"start":{"line":82,"column":1},"end":{"line":82,"column":1}},"children":[{"type":"text","value":"private","position":{"start":{"line":82,"column":1},"end":{"line":82,"column":1}},"key":"qlzL2KhmNP"}],"key":"x9Ew8L6Fu5"},{"type":"text","value":" key will now be able to push to the repo.","position":{"start":{"line":82,"column":1},"end":{"line":82,"column":1}},"key":"nLmnVoFgJ3"}],"key":"hJQHj2s542"},{"type":"heading","depth":2,"position":{"start":{"line":85,"column":1},"end":{"line":85,"column":1}},"children":[{"type":"text","value":"Step 3: Set up CircleCI for your “primary” repository","position":{"start":{"line":85,"column":1},"end":{"line":85,"column":1}},"key":"Tv11kekVz3"}],"identifier":"step-3-set-up-circleci-for-your-primary-repository","label":"Step 3: Set up CircleCI for your “primary” repository","html_id":"step-3-set-up-circleci-for-your-primary-repository","implicit":true,"key":"QnupXjJacQ"},{"type":"paragraph","position":{"start":{"line":87,"column":1},"end":{"line":90,"column":1}},"children":[{"type":"text","value":"Next, we need to set up CircleCI to build our primary repository with continuous integration.\nI recommend following the ","position":{"start":{"line":87,"column":1},"end":{"line":87,"column":1}},"key":"A2dBeWZ44x"},{"type":"link","url":"https://circleci.com/docs/2.0/getting-started/","position":{"start":{"line":87,"column":1},"end":{"line":87,"column":1}},"children":[{"type":"text","value":"CircleCI getting started guide","position":{"start":{"line":87,"column":1},"end":{"line":87,"column":1}},"key":"JqjaMplH2X"}],"urlSource":"https://circleci.com/docs/2.0/getting-started/","key":"zBz1iN8IP8"},{"type":"text","value":".\nOnce you follow this, CircleCI will automatically generate new builds for your repository following the configuration\nyou specify in ","position":{"start":{"line":87,"column":1},"end":{"line":87,"column":1}},"key":"RXdEeqZXVn"},{"type":"inlineCode","value":".circleci/config.yml","position":{"start":{"line":87,"column":1},"end":{"line":87,"column":1}},"key":"eGi33od8bK"},{"type":"text","value":".","position":{"start":{"line":87,"column":1},"end":{"line":87,"column":1}},"key":"aogQitLApS"}],"key":"Wn8zeqgidK"},{"type":"paragraph","position":{"start":{"line":92,"column":1},"end":{"line":92,"column":1}},"children":[{"type":"text","value":"Here’s a good start for a config.yml file:","position":{"start":{"line":92,"column":1},"end":{"line":92,"column":1}},"key":"waOmjb3smL"}],"key":"Z6VDUgfI5b"},{"type":"code","lang":"yaml","value":"version: 2\njobs:\n  build:\n    branches:\n      only:\n        # Tell Circle only to build this branch\n        - gh-pages\n    docker:\n      # Any Docker image should do, since we only need git\n      - image: circleci/python:3.6-stretch\n    steps:\n      # This ensures that the working directory contains the contents of your repo\n      - checkout\n      # We'll add more steps here","position":{"start":{"line":94,"column":1},"end":{"line":109,"column":1}},"key":"kjG0y1reIX"},{"type":"paragraph","position":{"start":{"line":111,"column":1},"end":{"line":111,"column":1}},"children":[{"type":"text","value":"Next, we’ll configure that yaml file to do what we want.","position":{"start":{"line":111,"column":1},"end":{"line":111,"column":1}},"key":"Eh44EjiMqS"}],"key":"eXWvtivcC6"},{"type":"heading","depth":2,"position":{"start":{"line":113,"column":1},"end":{"line":113,"column":1}},"children":[{"type":"text","value":"Step 4: Configure CircleCI to push the primary repository to the mirror repository","position":{"start":{"line":113,"column":1},"end":{"line":113,"column":1}},"key":"mcfSWQeaaR"}],"identifier":"step-4-configure-circleci-to-push-the-primary-repository-to-the-mirror-repository","label":"Step 4: Configure CircleCI to push the primary repository to the mirror repository","html_id":"step-4-configure-circleci-to-push-the-primary-repository-to-the-mirror-repository","implicit":true,"key":"bvdSm9EQw8"},{"type":"paragraph","position":{"start":{"line":115,"column":1},"end":{"line":116,"column":1}},"children":[{"type":"text","value":"Now that CircleCI is building the primary repo, it’s time to tell it to do what we want.\nWe’ll modify the workflow in the ","position":{"start":{"line":115,"column":1},"end":{"line":115,"column":1}},"key":"IuFZdb18DS"},{"type":"inlineCode","value":".circleci/config.yml","position":{"start":{"line":115,"column":1},"end":{"line":115,"column":1}},"key":"V00672wI4O"},{"type":"text","value":" file to do the following:","position":{"start":{"line":115,"column":1},"end":{"line":115,"column":1}},"key":"g2QmkAYRVE"}],"key":"H5DyDVvzdd"},{"type":"list","ordered":true,"start":1,"spread":false,"position":{"start":{"line":118,"column":1},"end":{"line":121,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":118,"column":1},"end":{"line":118,"column":1}},"children":[{"type":"text","value":"add the mirror repository as a git remote","position":{"start":{"line":118,"column":1},"end":{"line":118,"column":1}},"key":"JaJIvoEIBw"}],"key":"vxOF0iM2rK"},{"type":"listItem","spread":true,"position":{"start":{"line":119,"column":1},"end":{"line":121,"column":1}},"children":[{"type":"text","value":"push the latest copy of ","position":{"start":{"line":119,"column":1},"end":{"line":119,"column":1}},"key":"yY8xwTqOSN"},{"type":"inlineCode","value":"master","position":{"start":{"line":119,"column":1},"end":{"line":119,"column":1}},"key":"F7DvY6cRKN"},{"type":"text","value":" from the primary repository to the mirror repository\n(the latest version of the primary repository is already in the CircleCI build because of the ","position":{"start":{"line":119,"column":1},"end":{"line":119,"column":1}},"key":"VNsYMAr7cA"},{"type":"inlineCode","value":"- checkout","position":{"start":{"line":119,"column":1},"end":{"line":119,"column":1}},"key":"WQlgNdRhEp"},{"type":"text","value":" command).","position":{"start":{"line":119,"column":1},"end":{"line":119,"column":1}},"key":"FF7fS9Lt9Y"}],"key":"Ol42BH6H43"}],"key":"ag0fOieAtb"},{"type":"paragraph","position":{"start":{"line":122,"column":1},"end":{"line":122,"column":1}},"children":[{"type":"text","value":"Here’s the piece of configuration to do do this:","position":{"start":{"line":122,"column":1},"end":{"line":122,"column":1}},"key":"yFKNyKtZMl"}],"key":"etZm8qYF23"},{"type":"code","lang":"yaml","value":"version: 2\njobs:\n  build:\n    steps:\n      # Push to the inferentialthinking.github.io repository so it goes live\n      - run: git remote add live_textbook git@github.com:inferentialthinking/inferentialthinking.github.io.git\n      - run:\n          name: Updating inferentialthinking website\n          command: git push live_textbook gh-pages:master","position":{"start":{"line":124,"column":1},"end":{"line":134,"column":1}},"key":"UIPaYokxSm"},{"type":"paragraph","position":{"start":{"line":136,"column":1},"end":{"line":139,"column":1}},"children":[{"type":"text","value":"Now we’re telling CircleCI to push to our mirror repository, but\nyou’ll notice that it won’t be able to complete this action. This is because CircleCI doesn’t\ncurrently have the ","position":{"start":{"line":136,"column":1},"end":{"line":136,"column":1}},"key":"AUvpzTnYs9"},{"type":"strong","position":{"start":{"line":136,"column":1},"end":{"line":136,"column":1}},"children":[{"type":"text","value":"permissions","position":{"start":{"line":136,"column":1},"end":{"line":136,"column":1}},"key":"tGAKpFcCEG"}],"key":"SHp1YbBPXu"},{"type":"text","value":" needed to push to the mirror repository.\nTime to use that public/private key from before!","position":{"start":{"line":136,"column":1},"end":{"line":136,"column":1}},"key":"yxV8AI2tyy"}],"key":"cvzoPcmgFS"},{"type":"heading","depth":2,"position":{"start":{"line":141,"column":1},"end":{"line":141,"column":1}},"children":[{"type":"text","value":"Step 5: Add your private key to the primary repository Circle CI settings","position":{"start":{"line":141,"column":1},"end":{"line":141,"column":1}},"key":"z6seuyb2Ue"}],"identifier":"step-5-add-your-private-key-to-the-primary-repository-circle-ci-settings","label":"Step 5: Add your private key to the primary repository Circle CI settings","html_id":"step-5-add-your-private-key-to-the-primary-repository-circle-ci-settings","implicit":true,"key":"vFW0mp1v2h"},{"type":"paragraph","position":{"start":{"line":143,"column":1},"end":{"line":148,"column":1}},"children":[{"type":"text","value":"Next, we need to give CircleCI the ability to push to our mirror\nrepository by using the public/private key that we generated earlier. Remember\nthat anybody with the ","position":{"start":{"line":143,"column":1},"end":{"line":143,"column":1}},"key":"j4izhTT7Hd"},{"type":"strong","position":{"start":{"line":143,"column":1},"end":{"line":143,"column":1}},"children":[{"type":"text","value":"private","position":{"start":{"line":143,"column":1},"end":{"line":143,"column":1}},"key":"Q7uvudt8qX"}],"key":"CDzgUUQJ6q"},{"type":"text","value":" key can push to your mirror\nrepository. We can add the private key in a secure fashion to our\nCircleCI builds using their interface. Go to the ","position":{"start":{"line":143,"column":1},"end":{"line":143,"column":1}},"key":"fw860hlgDo"},{"type":"emphasis","position":{"start":{"line":143,"column":1},"end":{"line":143,"column":1}},"children":[{"type":"text","value":"settings","position":{"start":{"line":143,"column":1},"end":{"line":143,"column":1}},"key":"hq5Y4Xtdcc"}],"key":"JXMo20PygP"},{"type":"text","value":"\npage for your repository within CircleCI, then ","position":{"start":{"line":143,"column":1},"end":{"line":143,"column":1}},"key":"muD0O0RnD2"},{"type":"inlineCode","value":"SSH Permissions -> Add SSH Key","position":{"start":{"line":143,"column":1},"end":{"line":143,"column":1}},"key":"TEA4SvjOvD"},{"type":"text","value":".","position":{"start":{"line":143,"column":1},"end":{"line":143,"column":1}},"key":"DflSYr9MVR"}],"key":"Rmzxvc4UEQ"},{"type":"image","url":"/build/circleci-add-ssh-ui-f74c9f9579584a6e04f81b43aafcf521.png","position":{"start":{"line":150,"column":1},"end":{"line":150,"column":1}},"key":"BLYiiPG7zj","urlSource":"../../images/2018/circleci-add-ssh-ui.png"},{"type":"paragraph","position":{"start":{"line":152,"column":1},"end":{"line":153,"column":1}},"children":[{"type":"text","value":"This brings up a dialog where you can add your ","position":{"start":{"line":152,"column":1},"end":{"line":152,"column":1}},"key":"USBptI0Tyc"},{"type":"strong","position":{"start":{"line":152,"column":1},"end":{"line":152,"column":1}},"children":[{"type":"text","value":"private","position":{"start":{"line":152,"column":1},"end":{"line":152,"column":1}},"key":"yMcnQhhTMf"}],"key":"aJ3rDOqvGr"},{"type":"text","value":" key. This is the text\ninside ","position":{"start":{"line":152,"column":1},"end":{"line":152,"column":1}},"key":"Pnm9KhPrzg"},{"type":"inlineCode","value":"~/key.txt","position":{"start":{"line":152,"column":1},"end":{"line":152,"column":1}},"key":"HHmUYlgH5p"},{"type":"text","value":". Copy that text and paste it in the ","position":{"start":{"line":152,"column":1},"end":{"line":152,"column":1}},"key":"hG52131E08"},{"type":"inlineCode","value":"Private Key","position":{"start":{"line":152,"column":1},"end":{"line":152,"column":1}},"key":"rdnsbHf3lh"},{"type":"text","value":" box.","position":{"start":{"line":152,"column":1},"end":{"line":152,"column":1}},"key":"ucOgnvk0dn"}],"key":"SpIJGLhXhm"},{"type":"paragraph","position":{"start":{"line":155,"column":1},"end":{"line":155,"column":1}},"children":[{"type":"text","value":"In the ","position":{"start":{"line":155,"column":1},"end":{"line":155,"column":1}},"key":"XU3RF82MMM"},{"type":"inlineCode","value":"Hostname","position":{"start":{"line":155,"column":1},"end":{"line":155,"column":1}},"key":"wlTh6ctXjq"},{"type":"text","value":" box, put ","position":{"start":{"line":155,"column":1},"end":{"line":155,"column":1}},"key":"aXPKFSkFGX"},{"type":"inlineCode","value":"github.com","position":{"start":{"line":155,"column":1},"end":{"line":155,"column":1}},"key":"G9iOfnEgjS"},{"type":"text","value":".","position":{"start":{"line":155,"column":1},"end":{"line":155,"column":1}},"key":"h7kiKkfrf3"}],"key":"HJsJPWyI0w"},{"type":"image","url":"/build/circleci-private-key-e26047355526a0deaa3068626a2957a0.png","position":{"start":{"line":157,"column":1},"end":{"line":157,"column":1}},"key":"kJzF2WAdmq","urlSource":"../../images/2018/circleci-private-key-entry.png"},{"type":"paragraph","position":{"start":{"line":159,"column":1},"end":{"line":160,"column":1}},"children":[{"type":"text","value":"Now that CircleCI has our private key, we need to configure it to\nuse this key during builds.","position":{"start":{"line":159,"column":1},"end":{"line":159,"column":1}},"key":"jTtPxRLQvN"}],"key":"sCL6kGb3R4"},{"type":"paragraph","position":{"start":{"line":162,"column":1},"end":{"line":165,"column":1}},"children":[{"type":"strong","position":{"start":{"line":162,"column":1},"end":{"line":162,"column":1}},"children":[{"type":"text","value":"I’d recommend now deleting the ","position":{"start":{"line":162,"column":1},"end":{"line":162,"column":1}},"key":"Q0krJO6ygy"},{"type":"inlineCode","value":"key.txt","position":{"start":{"line":162,"column":1},"end":{"line":162,"column":1}},"key":"wPASxpLAzl"},{"type":"text","value":" and ","position":{"start":{"line":162,"column":1},"end":{"line":162,"column":1}},"key":"Lea028GQ3B"},{"type":"inlineCode","value":"key.txt.pub","position":{"start":{"line":162,"column":1},"end":{"line":162,"column":1}},"key":"JfCC2Ssu7L"},{"type":"text","value":" files from your computer,\njust to make sure they don’t accidentally fall in the wrong hands","position":{"start":{"line":162,"column":1},"end":{"line":162,"column":1}},"key":"LZOmCcB2RA"}],"key":"GJo2vNiEi1"},{"type":"text","value":". You can always generate\na new public/private pair and follow the steps above if you need to update the CircleCI deploy\nkeys.","position":{"start":{"line":162,"column":1},"end":{"line":162,"column":1}},"key":"CORfEehIZN"}],"key":"ZXccR3vjat"},{"type":"heading","depth":2,"position":{"start":{"line":167,"column":1},"end":{"line":167,"column":1}},"children":[{"type":"text","value":"Step 6: Modify your CircleCI configuration to use your private key","position":{"start":{"line":167,"column":1},"end":{"line":167,"column":1}},"key":"cVXFV2Cu47"}],"identifier":"step-6-modify-your-circleci-configuration-to-use-your-private-key","label":"Step 6: Modify your CircleCI configuration to use your private key","html_id":"step-6-modify-your-circleci-configuration-to-use-your-private-key","implicit":true,"key":"IbB5q9KogG"},{"type":"paragraph","position":{"start":{"line":169,"column":1},"end":{"line":171,"column":1}},"children":[{"type":"text","value":"Finally, we need to modify the yaml configuration so that it knows to use this\npublic/private key combination when it does SSH stuff in the build. That’s accomplished\nwith the following configuration:","position":{"start":{"line":169,"column":1},"end":{"line":169,"column":1}},"key":"zougFkAkjT"}],"key":"f6ZqGsvpEk"},{"type":"code","lang":"yaml","value":"jobs:\n  build:\n    steps:\n      # Add deployment key fingerprint for CircleCI to use for a push\n      - add_ssh_keys:\n          fingerprints:\n            # The SSH key fingerprint\n            - \"XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX\"","position":{"start":{"line":173,"column":1},"end":{"line":182,"column":1}},"key":"eGCzGOeJPR"},{"type":"paragraph","position":{"start":{"line":184,"column":1},"end":{"line":186,"column":1}},"children":[{"type":"text","value":"The SSH key fingerprint can be found by looking at your GitHub repository’s “Deploy Keys”\npage. It’ll contain a SHA that is unique and refers to the key you want. Copy and paste\nit using the configuration structure above. Here’s what one key looks like:","position":{"start":{"line":184,"column":1},"end":{"line":184,"column":1}},"key":"U3rrKQCBzt"}],"key":"ShrQG4UuBZ"},{"type":"image","url":"/build/circleci-fingerprint-663eb9ffb3733ba01545ec2bb50464a6.png","position":{"start":{"line":188,"column":1},"end":{"line":188,"column":1}},"key":"FcnuG9Z8GK","urlSource":"../../images/2018/circleci-fingerprint.png"},{"type":"heading","depth":2,"position":{"start":{"line":190,"column":1},"end":{"line":190,"column":1}},"children":[{"type":"text","value":"Our final configuration","position":{"start":{"line":190,"column":1},"end":{"line":190,"column":1}},"key":"hV0h7llqDV"}],"identifier":"our-final-configuration","label":"Our final configuration","html_id":"our-final-configuration","implicit":true,"key":"GC3wUFfhZZ"},{"type":"paragraph","position":{"start":{"line":192,"column":1},"end":{"line":194,"column":1}},"children":[{"type":"text","value":"That should be all we need to allow CircleCI to push the contents from the primary repository\nto the mirror repository. Every time a change is made to the ","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"key":"fKgsolTT0S"},{"type":"inlineCode","value":"master","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"key":"TMthXzqM90"},{"type":"text","value":" branch of the primary\nrepository, this process will be triggered.","position":{"start":{"line":192,"column":1},"end":{"line":192,"column":1}},"key":"lVUQia4vBB"}],"key":"ngd0jLvhcW"},{"type":"paragraph","position":{"start":{"line":196,"column":1},"end":{"line":196,"column":1}},"children":[{"type":"text","value":"This is what our final yaml configuration looks like:","position":{"start":{"line":196,"column":1},"end":{"line":196,"column":1}},"key":"zm0GQtBw4L"}],"key":"e0fHucXNqA"},{"type":"code","lang":"yaml","value":"version: 2\njobs:\n  build:\n    # Only build for changes to the gh-pages branch\n    branches:\n      only:\n        - gh-pages\n    # The base environment we'll use (can be any docker image w/ git)\n    docker:\n      - image: circleci/python:3.6-stretch\n    steps:\n      # Move the repository code to our home directory in the CircleCI build\n      - checkout\n      # Add deployment key fingerprint for CircleCI to use for a push\n      - add_ssh_keys:\n          fingerprints:\n            - \"XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX\"\n\n      # Add the mirror repository as a git remote\n      - run: git remote add live_textbook git@github.com:inferentialthinking/inferentialthinking.github.io.git\n      # Push the repository to the mirror site\n      - run:\n          name: Updating inferentialthinking website\n          command: git push live_textbook gh-pages:master","position":{"start":{"line":198,"column":1},"end":{"line":223,"column":1}},"key":"ZkeEXegPcR"}],"key":"opyLMSHAyP"}],"key":"UCKVtP56TZ"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Testing Pandoc and Jupyter Notebooks","url":"/blog/2019/2019-11-11-ipynb-pandoc","group":"2019"},"next":{"title":"Using CircleCI to preview documentation in Pull Requests","url":"/blog/2018/circle-docs","group":"2018"}}},"domain":"http://localhost:3000"}