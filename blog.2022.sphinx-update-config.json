{"version":2,"kind":"Article","sha256":"9d0e88f3543fd2894eeef2765d0c635d4beca5ab12705b3ba16c0ec25dc2e4a4","slug":"blog.2022.sphinx-update-config","location":"/blog/2022/sphinx-update-config.md","dependencies":[],"frontmatter":{"title":"How to update Sphinx options during the build","tags":["sphinx"],"date":"2022-12-05","content_includes_title":false,"authors":[{"id":"chris","nameParsed":{"literal":"Chris Holdgraf","given":"Chris","family":"Holdgraf"},"name":"Chris Holdgraf","orcid":"0000-0002-2391-0678","affiliations":["affiliations-myst-generated-uid-0","affiliations-myst-generated-uid-1"],"url":"https://chrisholdgraf.com","github":"choldgraf","twitter":"choldgraf"}],"github":"https://github.com/choldgraf/choldgraf.github.io","affiliations":[{"name":"2i2c","url":"https://2i2c.org","id":"affiliations-myst-generated-uid-0"},{"name":"Project Jupyter","url":"https://jupyter.org","id":"affiliations-myst-generated-uid-1"}],"abbreviations":{"LF":"The Linux Foundation","JF":"The Jupyter Foundation","JEC":"Jupyter Executive Council","JFB":"The Jupyter Foundation Board","SSC":"Software Steering Council","OSPO":"Open Source Program Office"},"numbering":{"title":{"offset":2}},"source_url":"https://github.com/choldgraf/choldgraf.github.io/blob/main/blog/2022/sphinx-update-config.md","edit_url":"https://github.com/choldgraf/choldgraf.github.io/edit/main/blog/2022/sphinx-update-config.md","exports":[{"format":"md","filename":"sphinx-update-config.md","url":"/build/sphinx-update-config-d059254eb7ab2d9539a6a849ad653ec6.md"}]},"mdast":{"type":"root","children":[{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":10,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"As part of ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"D0NdsAYOqF"},{"type":"link","url":"https://github.com/pydata/pydata-sphinx-theme/pull/1075","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"the ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"zB8xe5RS7l"},{"type":"inlineCode","value":"pydata-sphinx-theme","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"DNcJUDGVDr"}],"urlSource":"https://github.com/pydata/pydata-sphinx-theme/pull/1075","data":{"kind":"issue","org":"pydata","repo":"pydata-sphinx-theme","issue_number":"1075"},"internal":false,"protocol":"github","key":"sGMzZKrsmm"},{"type":"text","value":" we have a few settings that auto-enable extensions and configure them on behalf of the user.\nIt has always been mysterious to me how to do this properly ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"xMbTfbc7u9"},{"type":"strong","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"during the Sphinx build","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"uuygDDQkph"}],"key":"vQBvRxJTXL"},{"type":"text","value":".\nIt’s easy to configure things with ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"Jh5dGdwR4m"},{"type":"inlineCode","value":"conf.py","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"M0sFPAQd0k"},{"type":"text","value":" ahead of time, but what if you want to manually set a value during the build?","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"zCc13xRDQS"}],"key":"DNua6fEDPt"},{"type":"paragraph","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"I finally figured it out, so documenting the process here.","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"OBxzX4lSqZ"}],"key":"HsQqONQwzz"},{"type":"heading","depth":2,"position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"Use the ","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"hgl68o5Z31"},{"type":"inlineCode","value":"builder-inited","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"QsZeuKEFZD"},{"type":"text","value":" event","position":{"start":{"line":16,"column":1},"end":{"line":16,"column":1}},"key":"eLtKBsMXtR"}],"identifier":"use-the-builder-inited-event","label":"Use the builder-inited event","html_id":"use-the-builder-inited-event","implicit":true,"key":"uxgHW3Sl9s"},{"type":"paragraph","position":{"start":{"line":18,"column":1},"end":{"line":19,"column":1}},"children":[{"type":"strong","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"Define a Sphinx event for ","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"OjvdMLJepJ"},{"type":"inlineCode","value":"builder-inited","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"v63i54qTjd"}],"key":"VbpV6HVF2y"},{"type":"text","value":". This will trigger after the builder has been selected, but before the environent is finalized for the build.\nThis should be a function that takes a single ","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"j0WXQyiX7C"},{"type":"inlineCode","value":"(app)","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"vq0K0guLWp"},{"type":"text","value":" parameter.","position":{"start":{"line":18,"column":1},"end":{"line":18,"column":1}},"key":"gTW6E6boI1"}],"key":"Qn5V4CuByZ"},{"type":"admonition","kind":"seealso","children":[{"type":"admonitionTitle","children":[{"type":"text","value":"See Also","key":"qg8hjIDHoQ"}],"key":"Yx4F6cLLDD"},{"type":"paragraph","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"text","value":"See ","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"fjbL8yNTLy"},{"type":"link","url":"https://www.sphinx-doc.org/en/master/extdev/appapi.html#sphinx-core-events","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"children":[{"type":"text","value":"the Sphinx Core Events documentation","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"fURimUrB8G"}],"urlSource":"https://www.sphinx-doc.org/en/master/extdev/appapi.html#sphinx-core-events","key":"gp0KUiQObN"},{"type":"text","value":" for more information about Sphinx’s events system.","position":{"start":{"line":22,"column":1},"end":{"line":22,"column":1}},"key":"O8z0xqlOLD"}],"key":"ReP21in7sD"}],"key":"ZfiOOMltGL"},{"type":"heading","depth":2,"position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"children":[{"type":"text","value":"Use ","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"FCA5N0JcMf"},{"type":"inlineCode","value":"app._raw_config","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"oY0YLUQJeZ"},{"type":"text","value":" to find the user-provided config","position":{"start":{"line":25,"column":1},"end":{"line":25,"column":1}},"key":"qV6EwatUoM"}],"identifier":"use-app-raw-config-to-find-the-user-provided-config","label":"Use app._raw_config to find the user-provided config","html_id":"use-app-raw-config-to-find-the-user-provided-config","implicit":true,"key":"zgImSTixo0"},{"type":"paragraph","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"strong","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"text","value":"Use the ","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"pGoq3DVFSq"},{"type":"inlineCode","value":"app._raw_config","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"dDWeIkaPXl"},{"type":"text","value":" object to detect user-given config","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"A35EraRChn"}],"key":"locZQZuwmZ"},{"type":"text","value":". ","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"zwsM0KQOKv"},{"type":"link","url":"https://github.com/sphinx-doc/sphinx/blob/ba080286b06cb9e0cadec59a6cf1f96aa11aef5a/sphinx/config.py#L151-L155","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"text","value":"This is first written when Sphinx is initialized","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"HZb8rchwiF"}],"urlSource":"https://github.com/sphinx-doc/sphinx/blob/ba080286b06cb9e0cadec59a6cf1f96aa11aef5a/sphinx/config.py#L151-L155","data":{"kind":"file","org":"sphinx-doc","repo":"sphinx","reference":"ba080286b06cb9e0cadec59a6cf1f96aa11aef5a","file":"sphinx/config.py","from":151,"to":155,"raw":"https://raw.githubusercontent.com/sphinx-doc/sphinx/ba080286b06cb9e0cadec59a6cf1f96aa11aef5a/sphinx/config.py"},"internal":false,"protocol":"github","key":"uVrBKAuq8w"},{"type":"text","value":" and should be a good indication of what the user provided.","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"DcCQvZkJsT"}],"key":"BgzRytIYlA"},{"type":"paragraph","position":{"start":{"line":29,"column":1},"end":{"line":30,"column":1}},"children":[{"type":"text","value":"This is useful if you only want to over-ride something if the ","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"mNumtpMquv"},{"type":"emphasis","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"children":[{"type":"text","value":"user didn’t set it themselves","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"KVOhLPgMse"}],"key":"dViNO8aoHo"},{"type":"text","value":".\nHowever, the ","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"Rv3ad4o6SW"},{"type":"inlineCode","value":"app.config","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"WJI8EQGIbm"},{"type":"text","value":" object will have ","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"kN5w4hAiI2"},{"type":"emphasis","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"children":[{"type":"text","value":"all","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"X5bZk23atw"}],"key":"w88KtgWn7Q"},{"type":"text","value":" of the config options, including defaults.","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"EcZ2AiFb0N"}],"key":"q2Q2Y58UMO"},{"type":"heading","depth":2,"position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"children":[{"type":"text","value":"Update configuration options with the ","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"h92eCKx4D7"},{"type":"inlineCode","value":"app.config","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"Xf86cX0mWw"},{"type":"text","value":" object","position":{"start":{"line":32,"column":1},"end":{"line":32,"column":1}},"key":"Xo2iIZJc3l"}],"identifier":"update-configuration-options-with-the-app-config-object","label":"Update configuration options with the app.config object","html_id":"update-configuration-options-with-the-app-config-object","implicit":true,"key":"toaEVj9SVj"},{"type":"paragraph","position":{"start":{"line":34,"column":1},"end":{"line":36,"column":1}},"children":[{"type":"strong","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"children":[{"type":"text","value":"Update ","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"bQtE4zI6BV"},{"type":"inlineCode","value":"app.config.keyname","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"w7TiXE7cbY"}],"key":"hG10MC8MY7"},{"type":"text","value":".\nYou can set and update configuration values directly with ","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"TkbOmfzZfP"},{"type":"inlineCode","value":"app.config.keyname = \"foo\"","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"X2FmyCIJEu"},{"type":"text","value":".\nThe way ","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"ptqdBuyeHp"},{"type":"link","url":"https://github.com/sphinx-doc/sphinx/blob/b1ca6b3e120d83c9bb64fdea310574afb9897c1a/sphinx/config.py#L233-L238","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"children":[{"type":"text","value":"Sphinx does this","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"ueGvpPJzR0"}],"urlSource":"https://github.com/sphinx-doc/sphinx/blob/b1ca6b3e120d83c9bb64fdea310574afb9897c1a/sphinx/config.py#L233-L238","data":{"kind":"file","org":"sphinx-doc","repo":"sphinx","reference":"b1ca6b3e120d83c9bb64fdea310574afb9897c1a","file":"sphinx/config.py","from":233,"to":238,"raw":"https://raw.githubusercontent.com/sphinx-doc/sphinx/b1ca6b3e120d83c9bb64fdea310574afb9897c1a/sphinx/config.py"},"internal":false,"protocol":"github","key":"akLYnPKdWK"},{"type":"text","value":" is by directly setting ","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"CDZ8e05FtF"},{"type":"inlineCode","value":"app.config.__dict__[\"keyname\"] = \"foo\"","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"QbGiYenW8i"},{"type":"text","value":", but this doesn’t seem to be necessary and I’m not sure why they do it that way.","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"BT6jkBENSr"}],"key":"FeaHoM0san"},{"type":"admonition","children":[{"type":"admonitionTitle","children":[{"type":"inlineCode","value":"app.config.values","position":{"start":{"line":38,"column":1},"end":{"line":38,"column":1}},"key":"pwIEUcmyge"},{"type":"text","value":" has the defaults!","position":{"start":{"line":38,"column":1},"end":{"line":38,"column":1}},"key":"FVrYtwtuDo"}],"key":"WUduWs4Kp6"},{"type":"paragraph","position":{"start":{"line":39,"column":1},"end":{"line":41,"column":1}},"children":[{"type":"text","value":"It might seem like ","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"key":"ANZGJvnVQ8"},{"type":"inlineCode","value":"app.config.values is the right place for this, but that isn't the case. ","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"key":"AKHplxSeOW"},{"type":"text","value":"app.config.values` has the ","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"key":"kau5aQ6Zc2"},{"type":"emphasis","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"children":[{"type":"text","value":"defaults","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"key":"exQAlknQVJ"}],"key":"Ph5oHdLkMC"},{"type":"text","value":" for Sphinx, and if you directly replace items, then Sphinx will behave unpredictably.\n","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"key":"Y40oXAqgmv"},{"type":"link","url":"https://github.com/sphinx-doc/sphinx/blob/b1ca6b3e120d83c9bb64fdea310574afb9897c1a/sphinx/config.py#L186-L195","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"children":[{"type":"text","value":"Here’s where Sphinx configures these defaults","position":{"start":{"line":39,"column":1},"end":{"line":39,"column":1}},"key":"sKWF8vnUPN"}],"urlSource":"https://github.com/sphinx-doc/sphinx/blob/b1ca6b3e120d83c9bb64fdea310574afb9897c1a/sphinx/config.py#L186-L195","data":{"kind":"file","org":"sphinx-doc","repo":"sphinx","reference":"b1ca6b3e120d83c9bb64fdea310574afb9897c1a","file":"sphinx/config.py","from":186,"to":195,"raw":"https://raw.githubusercontent.com/sphinx-doc/sphinx/b1ca6b3e120d83c9bb64fdea310574afb9897c1a/sphinx/config.py"},"internal":false,"protocol":"github","key":"R7681mgXpG"}],"key":"KPKkQoAIDu"}],"key":"LnVsAxkyI5"},{"type":"heading","depth":2,"position":{"start":{"line":44,"column":1},"end":{"line":44,"column":1}},"children":[{"type":"text","value":"Update HTML theme options with ","position":{"start":{"line":44,"column":1},"end":{"line":44,"column":1}},"key":"eDV0eO7z1q"},{"type":"inlineCode","value":"app.builder.theme_options","position":{"start":{"line":44,"column":1},"end":{"line":44,"column":1}},"key":"usM8XDqhvR"}],"identifier":"update-html-theme-options-with-app-builder-theme-options","label":"Update HTML theme options with app.builder.theme_options","html_id":"update-html-theme-options-with-app-builder-theme-options","implicit":true,"key":"y4cMKzarcF"},{"type":"paragraph","position":{"start":{"line":46,"column":1},"end":{"line":49,"column":1}},"children":[{"type":"strong","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"children":[{"type":"text","value":"Update ","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"HwywIEtNNM"},{"type":"inlineCode","value":"app.builder.theme_options","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"kv5s4qdBPQ"}],"key":"Szczep8j8D"},{"type":"text","value":".\nMany people (including myself) incorrectly try to update ","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"MmDvK1WKKW"},{"type":"inlineCode","value":"app.config.html_theme_options","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"B3rvoFPSvp"},{"type":"text","value":" during a build event.\nBut this doesn’t do anything because the’ve already been copied over to ","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"PHjHTMuEVi"},{"type":"inlineCode","value":"app.builder.theme_options","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"XyNdnlKM1i"},{"type":"text","value":" early in the build process.\nAnnoyingly, the copied dictionary in ","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"CrVSYRnkTp"},{"type":"inlineCode","value":"app.builder.theme_options","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"T2RBI0ZiCC"},{"type":"text","value":" does not point to the same points in memory as ","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"cBAWqyEcWW"},{"type":"inlineCode","value":"app.config.html_theme_options","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"BhzjsQwKHb"},{"type":"text","value":".","position":{"start":{"line":46,"column":1},"end":{"line":46,"column":1}},"key":"SnCV2PbkKY"}],"key":"fiwIQIAo1x"},{"type":"paragraph","position":{"start":{"line":51,"column":1},"end":{"line":51,"column":1}},"children":[{"type":"text","value":"This ","position":{"start":{"line":51,"column":1},"end":{"line":51,"column":1}},"key":"AHLaPO710j"},{"type":"link","url":"https://github.com/sphinx-doc/sphinx/blob/ba080286b06cb9e0cadec59a6cf1f96aa11aef5a/sphinx/builders/html/__init__.py#L301-L307","position":{"start":{"line":51,"column":1},"end":{"line":51,"column":1}},"children":[{"type":"text","value":"copy action is done here","position":{"start":{"line":51,"column":1},"end":{"line":51,"column":1}},"key":"h8kMIZZzgQ"}],"urlSource":"https://github.com/sphinx-doc/sphinx/blob/ba080286b06cb9e0cadec59a6cf1f96aa11aef5a/sphinx/builders/html/__init__.py#L301-L307","data":{"kind":"file","org":"sphinx-doc","repo":"sphinx","reference":"ba080286b06cb9e0cadec59a6cf1f96aa11aef5a","file":"sphinx/builders/html/__init__.py","from":301,"to":307,"raw":"https://raw.githubusercontent.com/sphinx-doc/sphinx/ba080286b06cb9e0cadec59a6cf1f96aa11aef5a/sphinx/builders/html/__init__.py"},"internal":false,"protocol":"github","key":"og4BxnRyMC"},{"type":"text","value":".","position":{"start":{"line":51,"column":1},"end":{"line":51,"column":1}},"key":"Snuj4lrQXO"}],"key":"cI0paH3v5z"},{"type":"heading","depth":2,"position":{"start":{"line":53,"column":1},"end":{"line":53,"column":1}},"children":[{"type":"text","value":"An example","position":{"start":{"line":53,"column":1},"end":{"line":53,"column":1}},"key":"HDq0Osc2st"}],"identifier":"an-example","label":"An example","html_id":"an-example","implicit":true,"key":"hiFzdEtAoS"},{"type":"paragraph","position":{"start":{"line":55,"column":1},"end":{"line":55,"column":1}},"children":[{"type":"text","value":"Here’s an example of the whole process in action:","position":{"start":{"line":55,"column":1},"end":{"line":55,"column":1}},"key":"HDLLTGsA7q"}],"key":"EJpr8HHyPW"},{"type":"code","lang":"python","value":"# This function will update a single configuration value\ndef update_config(app):\n   # Check if a value was provided by the user\n   if \"foo\" in app.config._raw_values:\n      # Update a config value\n      app.config.__dict__[\"foo\"] = \"bar\"\n\n   # Update an HTML theme value\n   app.builder.theme_options[\"foo2\"] = \"bar2\"\n\n# Register the above function to be called during the builder-inited phase\ndef setup(app):\n  app.connect(\"builder-inited\", update_config)","position":{"start":{"line":57,"column":1},"end":{"line":71,"column":1}},"key":"vnHGzTJ3nX"}],"key":"hBAoQtZuAz"}],"key":"OBOllB1QTk"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Automatically redirect folders in Sphinx websites","url":"/blog/2022/sphinx-redirects-folder","group":"2022"},"next":{"title":"Serving in two roles at once via pre-recorded tutorials","url":"/blog/2021/2021-12-18-hybrid-tutorial-prerecord","group":"2021"}}},"domain":"http://localhost:3000"}