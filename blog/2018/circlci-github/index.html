
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<meta property="og:title" content="Automatically mirror a github repository with CircleCI" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://chrisholdgraf.com/blog/2018/circlci-github/" />
<meta property="og:site_name" content="Chris Holdgraf" />
<meta property="og:description" content="tl;dr: you can automatically mirror the contents of one repository to another by using CI/CD services like CircleCI. This post shows you one way to do it using secrets that let you push to a GitHub..." />
<meta property="og:image" content="https://chrisholdgraf.com/_images/social_previews/summary_blog_2018_circlci-github_9d1ca3bd.png" />
<meta property="og:image:alt" content="tl;dr: you can automatically mirror the contents of one repository to another by using CI/CD services like CircleCI. This post shows you one way to do it usi..." />
<meta name="description" content="tl;dr: you can automatically mirror the contents of one repository to another by using CI/CD services like CircleCI. This post shows you one way to do it using secrets that let you push to a GitHub..." />

    <title>Automatically mirror a github repository with CircleCI &#8212; Chris Holdgraf</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=961bdc270ee8274e4563" rel="stylesheet" />
<link href="../../../_static/styles/bootstrap.css?digest=961bdc270ee8274e4563" rel="stylesheet" />
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=961bdc270ee8274e4563" rel="stylesheet" />

  
  <link href="../../../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=961bdc270ee8274e4563" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/sphinx-examples.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/bootstrap.js?digest=961bdc270ee8274e4563" />
<link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=961bdc270ee8274e4563" />

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/design-tabs.js"></script>
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-88310237-1"></script>
    <script>
                window.dataLayer = window.dataLayer || [];
                function gtag(){ dataLayer.push(arguments); }
                gtag('js', new Date());
                gtag('config', 'UA-88310237-1');
            </script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'blog/2018/circlci-github';</script>
    <link rel="shortcut icon" href="../../../_static/profile-color-circle-small.png"/>
    <link rel="author" title="About these documents" href="../../../about/" />
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" /> 
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/> 
<link
  rel="alternate"
  type="application/atom+xml"
  href="../../../blog/atom.xml"
  title="Chris Holdgraf"
/>
 
<style type="text/css">
  ul.ablog-archive {
    list-style: none;
    overflow: auto;
    margin-left: 0px;
  }
  ul.ablog-archive li {
    float: left;
    margin-right: 5px;
    font-size: 80%;
  }
  ul.postlist a {
    font-style: italic;
  }
  ul.postlist-style-disc {
    list-style-type: disc;
  }
  ul.postlist-style-none {
    list-style-type: none;
  }
  ul.postlist-style-circle {
    list-style-type: circle;
  }
</style>

  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target="#bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../../search/"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this site..."
         aria-label="Search this site..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
      
  

<a class="navbar-brand logo" href="../../../">
  
  
  
  
  
    <p class="title logo__title">Chris Holdgraf</p>
  
</a>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="me-auto">
      
        <div class="navbar-center-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul id="navbar-main-elements" class="navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../about/">
                        About me
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../projects/">
                        Projects
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../publications/">
                        Published
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../talks/">
                        Talks
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../">
                        Blog
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    <div id="navbar-end">
      
        <div class="navbar-end-item navbar-persistent--container">
          
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
        </div>
      
      
        <div class="navbar-end-item"><button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button></div>
      
        <div class="navbar-end-item"><ul id="navbar-icon-links"
    class="navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/choldgraf/" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/choldgraf" title="Twitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://hachyderm.io/@choldgraf" title="Mastodon" class="nav-link" rel="me" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-mastodon"></i></span>
            <label class="sr-only">Mastodon</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://chrisholdgraf.com/blog/atom.xml" title="Blog RSS feed" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-solid fa-rss"></i></span>
            <label class="sr-only">Blog RSS feed</label></a>
        </li>
</ul></div>
      
    </div>
  </div>
  
  
    <div class="navbar-persistent--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-center-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul id="navbar-main-elements" class="navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../about/">
                        About me
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../projects/">
                        Projects
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../publications/">
                        Published
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../../talks/">
                        Talks
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../">
                        Blog
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-end-item"><button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
</button></div>
        
          <div class="navbar-end-item"><ul id="navbar-icon-links"
    class="navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/choldgraf/" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://twitter.com/choldgraf" title="Twitter" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-twitter"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="https://hachyderm.io/@choldgraf" title="Mastodon" class="nav-link" rel="me" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-mastodon"></i></span>
            <label class="sr-only">Mastodon</label></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://chrisholdgraf.com/blog/atom.xml" title="Blog RSS feed" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-solid fa-rss"></i></span>
            <label class="sr-only">Blog RSS feed</label></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-start-items sidebar-primary__section">
        <div class="sidebar-start-items__item">  
<h2>
   <i class="fa fa-calendar"></i>
  18 December 2018 
</h2>

<ul>
      
<li id="category">
  <span><i class="fa-fw fa fa-folder-open"></i></span
  >
   
  <a href="../../category/til/">til</a>  
</li>
 
<li id="tags">
  <span><i class="fa-fw fa fa-tags"></i> </span
  >
   
  <a href="../../tag/productivity/">productivity</a>   
  <a href="../../tag/cicd/">CICD</a>  
</li>
 
</ul>
</div>
        <div class="sidebar-start-items__item">
<h3>
  <a href="../../">Recent Posts</a>
</h3>
<ul>
   
  <li>
    <a href="../../2023/fosdem/"
      >06 February - Reflections from FOSDEM23: the beautiful chaos of open source in a conference</a
    >
  </li>
  
  <li>
    <a href="../../2022/install-github-from-pyproject/"
      >31 December - Install dependencies from GitHub with pyproject.toml or requirements.txt</a
    >
  </li>
  
  <li>
    <a href="../../2022/jupyterlite-workshop/"
      >10 December - Report from the JupyterLite workshop: WebAssembly is pretty cool</a
    >
  </li>
  
  <li>
    <a href="../../2022/matplotlib-remote-font/"
      >06 December - Load and plot a remote font with Matplotlib</a
    >
  </li>
  
  <li>
    <a href="../../2022/sphinx-update-config/"
      >05 December - Update Sphinx configuration during the build by modifying app.config</a
    >
  </li>
  
</ul>
</div>
        <div class="sidebar-start-items__item">
<h3>
  <a href="../../archive/">Archives</a>
</h3>
<ul>
   
  <li>
    <a href="../../2023/">2023 (1)</a>
  </li>
    
  <li>
    <a href="../../2022/">2022 (11)</a>
  </li>
    
  <li>
    <a href="../../2021/">2021 (1)</a>
  </li>
    
  <li>
    <a href="../../2020/">2020 (4)</a>
  </li>
    
  <li>
    <a href="../../2019/">2019 (7)</a>
  </li>
    
  <li>
    <a href="../">2018 (11)</a>
  </li>
    
  <li>
    <a href="../../2017/">2017 (3)</a>
  </li>
    
  <li>
    <a href="../../2016/">2016 (6)</a>
  </li>
    
  <li>
    <a href="../../2015/">2015 (4)</a>
  </li>
   
</ul>
</div>
    </div>
  
  
  <div class="sidebar-end-items sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>

      </div>
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article"></div>
              
              

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                   <section id="automatically-mirror-a-github-repository-with-circleci">
<h1>Automatically mirror a github repository with CircleCI<a class="headerlink" href="#automatically-mirror-a-github-repository-with-circleci" title="Permalink to this heading">#</a></h1>
<blockquote>
<div><p>tl;dr: you can automatically mirror the contents of one repository to another by
using CI/CD services like CircleCI. This post shows you one way to do it using
secrets that let you push to a GitHub repository from a CircleCI process.</p>
</div></blockquote>
<p>We recently ran into an issue with the Data 8 course where we needed to mirror
one GitHub site to another. In short, the textbook is built with a tool called
<a class="reference external" href="https://chrisholdgraf.com/jupyter-book/intro.html">jupyter-book</a>, and we use <a class="reference external" href="https://pages.github.com/">github-pages</a>
to host the content at <a class="reference external" href="https://inferentialthinking.com">inferentialthinking.com</a>.
For <a class="reference external" href="https://help.github.com/articles/custom-domain-redirects-for-github-pages-sites/">weird URL-naming reasons</a>,
we had to create <a class="reference external" href="https://github.com/inferentialthinking/inferentialthinking.github.io">a second organization</a>
to host the actual site. This introduced the complexity that any time the textbook
had to be updated, we did so in <em>two</em> different places. The raw textbook content
is hosted at https://github.com/data-8/textbook, and the version hosted online is
at https://github.com/inferentialthinking/inferentialthinking.github.io.</p>
<p>This is a pain, because now a person has to take several actions across two repositories
any time we update the textbook content. But not anymore! Now we use CirleCI to automatically deploy an update to
inferentialthinking.com any time a change is made to data-8/textbook. Here
are the steps to do it.</p>
<p>In these steps, we’ll have two repositories, one with the “primary” repository
we want to keep, and one with the “mirror” repository that should always contain
exactly the content of the “primary” repo. I’ll call these “primary” and “mirror”
repos from here on out (no, I won’t call them master and slave but that’s a whole
other conversation).</p>
<section id="what-we-want-to-do">
<h2>What we want to do<a class="headerlink" href="#what-we-want-to-do" title="Permalink to this heading">#</a></h2>
<p>Ultimately, we’d like the following thing to happen:</p>
<blockquote>
<div><p><strong>Whenever a change is pushed to the “primary” repository, CircleCI should push
those changes to the “mirror” repository.</strong></p>
</div></blockquote>
<p>Since CircleCI already lets you run semi-arbitrary code, this is relatively
straightforward, with one big caveat: permissions. GitHub doesn’t let <em>anybody</em>
push to <em>any</em> repository, so we need some way to allow CircleCI to push to
our mirror repository. That’s what these steps are all about.</p>
</section>
<section id="step-1-create-an-ssh-key-for-your-mirror-github-repository">
<h2>Step 1: Create an SSH key for your mirror github repository<a class="headerlink" href="#step-1-create-an-ssh-key-for-your-mirror-github-repository" title="Permalink to this heading">#</a></h2>
<p>First off, we need to tell the mirror repository “you should let anyone with
these credentials push to the repo”. We’ll do this by creating a “deploy key”.
This is a SSH public/private key pair that, when combined, will allow anybody
to push to your repository. <strong>If anybody has the private key, they have push access
to your repo</strong>, so keep the private key safe!</p>
<p>First, create a new public/private key pair with this command (in a *nix system):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span><span class="o">-</span><span class="n">keygen</span> <span class="o">-</span><span class="n">f</span> <span class="o">~/</span><span class="n">key</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p><strong>when it asks for a passphrase, simply hit enter twice</strong>. This makes the passphrase empty.</p>
<p>This generates two files in your home directory:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">key.txt</span></code> is your private key. You <strong>should not share this w/ others</strong> unless you know what you’re doing.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">key.txt.pub</span></code> is your public key. You can share this w/ others.</p></li>
</ul>
</section>
<section id="step-2-add-this-ssh-key-as-a-deploy-key-to-your-mirror-repo">
<h2>Step 2: Add this SSH key as a “deploy key” to your mirror repo<a class="headerlink" href="#step-2-add-this-ssh-key-as-a-deploy-key-to-your-mirror-repo" title="Permalink to this heading">#</a></h2>
<p>In your github repository, go to <code class="docutils literal notranslate"><span class="pre">settings</span> <span class="pre">-&gt;</span> <span class="pre">deploy</span> <span class="pre">keys</span> <span class="pre">-&gt;</span> <span class="pre">add</span> <span class="pre">deploy</span> <span class="pre">key</span></code>. See the diagram below for the steps:</p>
<p><img alt="" src="../../../_images/circleci-mirror-deploy-key-ui.png" /></p>
<p>When you click <code class="docutils literal notranslate"><span class="pre">add</span> <span class="pre">deploy</span> <span class="pre">key</span></code>, it’ll open an interface for you to add the <em>public</em> key for the
deployment permissions. Copy the text of your <strong>public key</strong> (at <code class="docutils literal notranslate"><span class="pre">~/key.txt.pub</span></code>) and paste it in the window like so:</p>
<p><img alt="" src="../../../_images/circleci-deploy-key-ssh.png" /></p>
<p>Remember, this is the <strong>public</strong> key for your repository. This means that anyone
with the <strong>private</strong> key will now be able to push to the repo.</p>
</section>
<section id="step-3-set-up-circleci-for-your-primary-repository">
<h2>Step 3: Set up CircleCI for your “primary” repository<a class="headerlink" href="#step-3-set-up-circleci-for-your-primary-repository" title="Permalink to this heading">#</a></h2>
<p>Next, we need to set up CircleCI to build our primary repository with continuous integration.
I recommend following the <a class="reference external" href="https://circleci.com/docs/2.0/getting-started/">CircleCI getting started guide</a>.
Once you follow this, CircleCI will automatically generate new builds for your repository following the configuration
you specify in <code class="docutils literal notranslate"><span class="pre">.circleci/config.yml</span></code>.</p>
<p>Here’s a good start for a config.yml file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span>
<span class="w">      </span><span class="nt">only</span><span class="p">:</span>
<span class="w">        </span><span class="c1"># Tell Circle only to build this branch</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gh-pages</span>
<span class="w">    </span><span class="nt">docker</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># Any Docker image should do, since we only need git</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">circleci/python:3.6-stretch</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># This ensures that the working directory contains the contents of your repo</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">checkout</span>
<span class="w">      </span><span class="c1"># We&#39;ll add more steps here</span>
</pre></div>
</div>
<p>Next, we’ll configure that yaml file to do what we want.</p>
</section>
<section id="step-4-configure-circleci-to-push-the-primary-repository-to-the-mirror-repository">
<h2>Step 4: Configure CircleCI to push the primary repository to the mirror repository<a class="headerlink" href="#step-4-configure-circleci-to-push-the-primary-repository-to-the-mirror-repository" title="Permalink to this heading">#</a></h2>
<p>Now that CircleCI is building the primary repo, it’s time to tell it to do what we want.
We’ll modify the workflow in the <code class="docutils literal notranslate"><span class="pre">.circleci/config.yml</span></code> file to do the following:</p>
<ol class="arabic simple">
<li><p>add the mirror repository as a git remote</p></li>
<li><p>push the latest copy of <code class="docutils literal notranslate"><span class="pre">master</span></code> from the primary repository to the mirror repository
(the latest version of the primary repository is already in the CircleCI build because of the <code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">checkout</span></code> command).</p></li>
</ol>
<p>Here’s the piece of configuration to do do this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># Push to the inferentialthinking.github.io repository so it goes live</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">git remote add live_textbook git@github.com:inferentialthinking/inferentialthinking.github.io.git</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Updating inferentialthinking website</span>
<span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">git push live_textbook gh-pages:master</span>
</pre></div>
</div>
<p>Now we’re telling CircleCI to push to our mirror repository, but
you’ll notice that it won’t be able to complete this action. This is because CircleCI doesn’t
currently have the <strong>permissions</strong> needed to push to the mirror repository.
Time to use that public/private key from before!</p>
</section>
<section id="step-5-add-your-private-key-to-the-primary-repository-circle-ci-settings">
<h2>Step 5: Add your private key to the primary repository Circle CI settings<a class="headerlink" href="#step-5-add-your-private-key-to-the-primary-repository-circle-ci-settings" title="Permalink to this heading">#</a></h2>
<p>Next, we need to give CircleCI the ability to push to our mirror
repository by using the public/private key that we generated earlier. Remember
that anybody with the <strong>private</strong> key can push to your mirror
repository. We can add the private key in a secure fashion to our
CircleCI builds using their interface. Go to the <em>settings</em>
page for your repository within CircleCI, then <code class="docutils literal notranslate"><span class="pre">SSH</span> <span class="pre">Permissions</span> <span class="pre">-&gt;</span> <span class="pre">Add</span> <span class="pre">SSH</span> <span class="pre">Key</span></code>.</p>
<p><img alt="" src="../../../_images/circleci-add-ssh-ui.png" /></p>
<p>This brings up a dialog where you can add your <strong>private</strong> key. This is the text
inside <code class="docutils literal notranslate"><span class="pre">~/key.txt</span></code>. Copy that text and paste it in the <code class="docutils literal notranslate"><span class="pre">Private</span> <span class="pre">Key</span></code> box.</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">Hostname</span></code> box, put <code class="docutils literal notranslate"><span class="pre">github.com</span></code>.</p>
<p><img alt="" src="../../../_images/circleci-private-key-entry.png" /></p>
<p>Now that CircleCI has our private key, we need to configure it to
use this key during builds.</p>
<p><strong>I’d recommend now deleting the <code class="docutils literal notranslate"><span class="pre">key.txt</span></code> and <code class="docutils literal notranslate"><span class="pre">key.txt.pub</span></code> files from your computer,
just to make sure they don’t accidentally fall in the wrong hands</strong>. You can always generate
a new public/private pair and follow the steps above if you need to update the CircleCI deploy
keys.</p>
</section>
<section id="step-6-modify-your-circleci-configuration-to-use-your-private-key">
<h2>Step 6: Modify your CircleCI configuration to use your private key<a class="headerlink" href="#step-6-modify-your-circleci-configuration-to-use-your-private-key" title="Permalink to this heading">#</a></h2>
<p>Finally, we need to modify the yaml configuration so that it knows to use this
public/private key combination when it does SSH stuff in the build. That’s accomplished
with the following configuration:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># Add deployment key fingerprint for CircleCI to use for a push</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">add_ssh_keys</span><span class="p">:</span>
<span class="w">          </span><span class="nt">fingerprints</span><span class="p">:</span>
<span class="w">            </span><span class="c1"># The SSH key fingerprint</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX&quot;</span>
</pre></div>
</div>
<p>The SSH key fingerprint can be found by looking at your GitHub repository’s “Deploy Keys”
page. It’ll contain a SHA that is unique and refers to the key you want. Copy and paste
it using the configuration structure above. Here’s what one key looks like:</p>
<p><img alt="" src="../../../_images/circleci-fingerprint.png" /></p>
</section>
<section id="our-final-configuration">
<h2>Our final configuration<a class="headerlink" href="#our-final-configuration" title="Permalink to this heading">#</a></h2>
<p>That should be all we need to allow CircleCI to push the contents from the primary repository
to the mirror repository. Every time a change is made to the <code class="docutils literal notranslate"><span class="pre">master</span></code> branch of the primary
repository, this process will be triggered.</p>
<p>This is what our final yaml configuration looks like:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="nt">jobs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">build</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># Only build for changes to the gh-pages branch</span>
<span class="w">    </span><span class="nt">branches</span><span class="p">:</span>
<span class="w">      </span><span class="nt">only</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gh-pages</span>
<span class="w">    </span><span class="c1"># The base environment we&#39;ll use (can be any docker image w/ git)</span>
<span class="w">    </span><span class="nt">docker</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">circleci/python:3.6-stretch</span>
<span class="w">    </span><span class="nt">steps</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># Move the repository code to our home directory in the CircleCI build</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">checkout</span>
<span class="w">      </span><span class="c1"># Add deployment key fingerprint for CircleCI to use for a push</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">add_ssh_keys</span><span class="p">:</span>
<span class="w">          </span><span class="nt">fingerprints</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX:XX&quot;</span>

<span class="w">      </span><span class="c1"># Add the mirror repository as a git remote</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">git remote add live_textbook git@github.com:inferentialthinking/inferentialthinking.github.io.git</span>
<span class="w">      </span><span class="c1"># Push the repository to the mirror site</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">run</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Updating inferentialthinking website</span>
<span class="w">          </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">git push live_textbook gh-pages:master</span>
</pre></div>
</div>
</section>
</section>

<div class="section">
    

<div class="section">
  <span style="float: left">
     
    <a href="../free-labor-partners/">
      <i class="fa fa-arrow-circle-left"></i> Open communities need to be partners, not sources of free labor
    </a>
    
  </span>
  <span>&nbsp;</span>
  <span style="float: right">
     
    <a href="../../2019/2019-01-29-three-things-circleci/">
      Three things I love about CircleCI <i
        class="fa fa-arrow-circle-right"
      ></i
      >
    </a>
    
  </span>
</div>
  
</div>

                </article>
              
<!-- Add a comment box underneath the page's content -->
<script src="https://giscus.app/client.js"
        data-repo="choldgraf/choldgraf.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnk1MTIzNzA1NA=="
        data-category="Blog comments"
        data-category-id="DIC_kwDOAw3Qvs4CAV4E"
        data-mapping="pathname"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-theme="light"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>

              
              
                <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc">
  <div class="toc-item">
  <div class="tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav id="bd-toc-nav" class="page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-we-want-to-do">What we want to do</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-1-create-an-ssh-key-for-your-mirror-github-repository">Step 1: Create an SSH key for your mirror github repository</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-2-add-this-ssh-key-as-a-deploy-key-to-your-mirror-repo">Step 2: Add this SSH key as a “deploy key” to your mirror repo</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-3-set-up-circleci-for-your-primary-repository">Step 3: Set up CircleCI for your “primary” repository</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-4-configure-circleci-to-push-the-primary-repository-to-the-mirror-repository">Step 4: Configure CircleCI to push the primary repository to the mirror repository</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-5-add-your-private-key-to-the-primary-repository-circle-ci-settings">Step 5: Add your private key to the primary repository Circle CI settings</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#step-6-modify-your-circleci-configuration-to-use-your-private-key">Step 6: Modify your CircleCI configuration to use your private key</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#our-final-configuration">Our final configuration</a></li>
</ul>
  </nav></div>

  <div class="toc-item">
  <div class="tocsection sourcelink">
    <a href="../../../_sources/blog/2018/circlci-github.md.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>
</div>
              
            
          </div>
          <footer class="bd-footer-content">
            <div class="bd-footer-content__inner"></div>
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/bootstrap.js?digest=961bdc270ee8274e4563"></script>
<script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=961bdc270ee8274e4563"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
    <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2022, Chris Holdgraf.
      <br/>
    
  </p>
</div>
  
    <div class="footer-item"><p class="theme-version">
  Built with the
  <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a>
  0.13.0rc2.dev0.
</p></div>
  
    <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://sphinx-doc.org/">Sphinx</a> 5.3.0.
    <br/>
  </p>
</div>
  
</div>
  </footer>
  </body>
</html>