{"version":2,"kind":"Notebook","sha256":"a87840b6b6f9d5b677027ab959b5f9f4f77873f0c340c5eb8c82d7587d065eee","slug":"blog.2019.2019-10-22-xarray-neuro","location":"/blog/2019/2019-10-22-xarray-neuro.ipynb","dependencies":[],"frontmatter":{"title":"Analyzing intracranial electrophysiology data with xarray","tags":["analysis","neuroscience","xarray","open source"],"date":"2019-10-22","kernelspec":{"name":"python3","display_name":"Python 3","language":"python"},"content_includes_title":false,"authors":[{"id":"chris","nameParsed":{"literal":"Chris Holdgraf","given":"Chris","family":"Holdgraf"},"name":"Chris Holdgraf","orcid":"0000-0002-2391-0678","affiliations":["affiliations-myst-generated-uid-0","affiliations-myst-generated-uid-1"],"url":"https://chrisholdgraf.com","github":"choldgraf","twitter":"choldgraf"}],"github":"https://github.com/choldgraf/choldgraf.github.io","affiliations":[{"name":"2i2c","url":"https://2i2c.org","id":"affiliations-myst-generated-uid-0"},{"name":"Project Jupyter","url":"https://jupyter.org","id":"affiliations-myst-generated-uid-1"}],"abbreviations":{"LF":"The Linux Foundation","JF":"The Jupyter Foundation","JEC":"Jupyter Executive Council","JFB":"The Jupyter Foundation Board","SSC":"Software Steering Council","OSPO":"Open Source Program Office"},"numbering":{"title":{"offset":2}},"source_url":"https://github.com/choldgraf/choldgraf.github.io/blob/main/blog/2019/2019-10-22-xarray-neuro.ipynb","edit_url":"https://github.com/choldgraf/choldgraf.github.io/edit/main/blog/2019/2019-10-22-xarray-neuro.ipynb","exports":[{"format":"ipynb","filename":"2019-10-22-xarray-neuro.ipynb","url":"/build/2019-10-22-xarray-ne-71deb386ebad4df4cdd9c0ecdc5252d1.ipynb"}]},"widgets":{"application/vnd.jupyter.widget-state+json":{"state":{},"version_major":2,"version_minor":0},"date":"2019-10-22","redirect":"xarray-explore-ieeg","tags":["analysis","neuroscience","xarray","open source"]},"mdast":{"type":"root","children":[{"type":"block","children":[{"type":"paragraph","position":{"start":{"line":29,"column":1},"end":{"line":32,"column":1}},"children":[{"type":"text","value":"Over the last few years, it has been exciting to see the xarray project evolve,\nadd new functionality, and mature. This post is an attempt at\ngiving xarray another visit to see how it could integrate into electrophysiology\nworkflows.","position":{"start":{"line":29,"column":1},"end":{"line":29,"column":1}},"key":"L99tDTqozq"}],"key":"BzD1gWK16N"},{"type":"heading","depth":3,"position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"children":[{"type":"text","value":"A quick background on our data","position":{"start":{"line":34,"column":1},"end":{"line":34,"column":1}},"key":"bbSZPxcvWd"}],"identifier":"a-quick-background-on-our-data","label":"A quick background on our data","html_id":"a-quick-background-on-our-data","implicit":true,"key":"GVZ5kx18Ro"},{"type":"paragraph","position":{"start":{"line":36,"column":1},"end":{"line":40,"column":1}},"children":[{"type":"text","value":"It is common in neuroscience to ask individuals to perform a task over and over again. You record\nthe activity in the brain each time they perform the task (called an “epoch” or a “trial”).\nTime is recorded relative to some ","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"f8SuVUSGfn"},{"type":"emphasis","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"children":[{"type":"text","value":"onset","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"OUOyUuDCsg"}],"key":"x027Aq0AMZ"},{"type":"text","value":" when the task begins. That is ","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"mM3QUdwqQt"},{"type":"inlineCode","value":"t==0","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"frbp3b4YaW"},{"type":"text","value":". The result\nis usually a matrix of ","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"FVxiYoXqtI"},{"type":"inlineCode","value":"epochs x channejupyls x time","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"Rj41vxu1h0"},{"type":"text","value":". You can do a lot of stuff with this\ndata, but our task in this paper is to detect changes in neural activity at trial onset (","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"PHSv35F0V8"},{"type":"inlineCode","value":"t==0","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"x9gaprr1EI"},{"type":"text","value":").","position":{"start":{"line":36,"column":1},"end":{"line":36,"column":1}},"key":"xlu2kOODCI"}],"key":"C9BCkcfjbB"},{"type":"paragraph","position":{"start":{"line":42,"column":1},"end":{"line":48,"column":1}},"children":[{"type":"text","value":"In our case, we’ve got a small dataset from ","position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"key":"IlQRmtNjBW"},{"type":"cite","url":"https://www.frontiersin.org/articles/10.3389/fnsys.2017.00061/full","position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"children":[{"type":"text","value":"an old paper of mine","position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"key":"Rl3sFhlP74"}],"kind":"narrative","label":"Holdgraf_2017","identifier":"https://www.frontiersin.org/articles/10.3389/fnsys.2017.00061/full","enumerator":"1","key":"c08cqkpqMM"},{"type":"text","value":".\nThe repository contains\nseveral tutorial notebooks and sample data to describe predictive modeling\nin cognitive neuroscience. ","position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"key":"dOPoWfyVAF"},{"type":"link","url":"https://github.com/choldgraf/paper-encoding_decoding_electrophysiology","position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"children":[{"type":"text","value":"You can find the repository here","position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"key":"pC93e07kyn"}],"urlSource":"https://github.com/choldgraf/paper-encoding_decoding_electrophysiology","error":true,"key":"zAntWtb3si"},{"type":"text","value":". The task that individuals were performing was passively\nlistening to spoken sentences through a speaker. While they did this, we recorded electrical\nactivity at the surface of their brain (these were surgical patients, and had implanted electrodes\nunder their scalp).","position":{"start":{"line":42,"column":1},"end":{"line":42,"column":1}},"key":"DQ9E6XV0gT"}],"key":"PU6UdZPcM2"},{"type":"paragraph","position":{"start":{"line":50,"column":1},"end":{"line":53,"column":1}},"children":[{"type":"text","value":"In the ","position":{"start":{"line":50,"column":1},"end":{"line":50,"column":1}},"key":"UiJ8iAy62D"},{"type":"link","url":"https://github.com/choldgraf/paper-encoding_decoding_electrophysiology/blob/master/notebooks/FeatureExtraction.ipynb","position":{"start":{"line":50,"column":1},"end":{"line":50,"column":1}},"children":[{"type":"text","value":"Feature Extraction","position":{"start":{"line":50,"column":1},"end":{"line":50,"column":1}},"key":"nMnzQZjhU8"}],"urlSource":"https://github.com/choldgraf/paper-encoding_decoding_electrophysiology/blob/master/notebooks/FeatureExtraction.ipynb","data":{"kind":"file","org":"choldgraf","repo":"paper-encoding_decoding_electrophysiology","reference":"master","file":"notebooks/FeatureExtraction.ipynb","raw":"https://raw.githubusercontent.com/choldgraf/paper-encoding_decoding_electrophysiology/master/notebooks/FeatureExtraction.ipynb"},"internal":false,"protocol":"github","key":"oIwAukKCU2"},{"type":"text","value":" notebook,\nI covered how to do some simple data manipulation and feature extraction with\ntimeseries analysis. Let’s try to re-create some of the main steps in that tutorial,\nbut now using xarray as an in-memory structure for our data.","position":{"start":{"line":50,"column":1},"end":{"line":50,"column":1}},"key":"uxXVBitsae"}],"key":"B9i63GRwBM"}],"key":"JUlNizn7w5"},{"type":"block","kind":"notebook-content","data":{"tags":["popout"]},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Note","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fHRHC52WfU"}],"key":"yWpQNW3oqx"},{"type":"text","value":": The goal here is to learn a bit about xarray moreso than to discuss\necog modeling, so I’ll spend more time talking about my thoughts on the various\nfunctions/methods/etc in Xarray than talking about neuroscience.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UIC2G5cVvb"}],"key":"VRgnSxFGhQ"}],"visibility":"show","key":"W888EC3y1D"},{"type":"block","kind":"notebook-content","data":{"toc-hr-collapsed":false},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"In this post, we’ll perform a few common processing and extraction steps.\nThe goal is to do a few munging operations that require manipulating data\nand visualizing simple statistics.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BTGOmMdlM5"}],"key":"okxiCCXL8c"}],"key":"mQulSUN3iI"},{"type":"block","kind":"notebook-code","data":{"tags":["hide_input"]},"children":[{"type":"code","lang":"python","executable":true,"value":"# Imports we'll use later\nimport mne\nimport numpy as np\nimport matplotlib.pyplot as plt\nfrom download import download\nimport os\nfrom sklearn.preprocessing import scale\nimport xarray as xr\nxr.set_options(display_style=\"html\")\n\nimport warnings\nwarnings.simplefilter('ignore')\n%matplotlib inline","visibility":"show","key":"hSCNvUdMHu"},{"type":"output","id":"u0FyRYkqoMQvjxe-_zeaM","data":[],"visibility":"show","key":"R5GxKeE3wz"}],"visibility":"show","key":"EqiAvAYfHw"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"We’ll load the data from my GitHub repository (probably not the most efficient\nway to store or retrieve the data, but hey, this was 3 years ago :-) ).","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bLjbfKV4cf"}],"key":"f6ciZwGkMH"}],"key":"K26pPFhcwV"},{"type":"block","kind":"notebook-code","data":{"tags":["remove_output"]},"children":[{"type":"code","lang":"python","executable":true,"value":"url_epochs = \"https://github.com/choldgraf/paper-encoding_decoding_electrophysiology/blob/master/raw_data/ecog-epo.fif?raw=true\"\n\npath_data = download(url_epochs, './ecog-epo.fif', replace=True)\necog = mne.read_epochs(path_data, preload=True)\nos.remove(path_data)","visibility":"show","key":"bRlKy9Cld6"},{"type":"output","id":"rz5MVI944XOskyNNcx5Ou","data":[{"name":"stderr","output_type":"stream","text":"file_sizes:   0%|                                   | 0.00/8.36M [00:00<?, ?B/s]"},{"name":"stdout","output_type":"stream","text":"Downloading data from https://raw.githubusercontent.com/choldgraf/paper-encoding_decoding_electrophysiology/master/raw_data/ecog-epo.fif?raw=true (8.0 MB)\n\n"},{"name":"stderr","output_type":"stream","text":"file_sizes: 100%|██████████████████████████| 8.36M/8.36M [00:00<00:00, 12.5MB/s]"},{"name":"stdout","output_type":"stream","text":"Successfully downloaded file to ./ecog-epo.fif\nReading ./ecog-epo.fif ...\n"},{"name":"stderr","output_type":"stream","text":"\n"},{"name":"stdout","output_type":"stream","text":"Isotrak not found\n    Found the data of interest:\n        t =   -1500.00 ...    5996.67 ms\n        0 CTF compensation matrices available\n29 matching events found\nNo baseline correction applied\nNot setting metadata\n0 projection items activated\n"}],"visibility":"show","key":"H8DCJKKi7R"}],"visibility":"show","key":"O48FuElhCr"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Here’s what the raw data looks like - each horizontal line is electrical activity\nin a channel over time. The faint vertical green lines show the onset of\neach trial (they are concatenated together, but in reality there’s a bit of time\nbetween trials). This will be one of the last times we use MNE hopefully.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"s5kMfe3j20"}],"key":"qhNFUtVJVB"}],"key":"IghaoFv64w"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"_ = ecog.plot(scalings='auto', n_epochs=5, n_channels=10)","key":"HqvQ8aX2MY"},{"type":"output","id":"Eq-koYR4ciWara7zBArid","data":[{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"fc24837c97da2d130f181274745e4ae0","path":"/build/fc24837c97da2d130f181274745e4ae0.png"},"text/plain":{"content":"<Figure size 480x320 with 5 Axes>","content_type":"text/plain"}}}],"key":"fYSyGaDeCy"}],"key":"qiGRiifVdK"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Converting to xarray","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JhwwlgbAzP"}],"identifier":"converting-to-xarray","label":"Converting to xarray","html_id":"converting-to-xarray","implicit":true,"key":"PqokvzcvtL"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"First off, we’ll define a helper function that\nconverts the MNE Epochs object into an xarray DataArray object.\nDataArrays provide an N-Dimensional representation of data, but with\nthe option to include a lot of extra metadata.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ZcGc354X2Y"}],"key":"OopLFrvG0C"},{"type":"paragraph","position":{"start":{"line":8,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"DataArrays are useful because you can include information\n","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"tJMG56kK3y"},{"type":"emphasis","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"about each dimension","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"qhDrBigzu5"}],"key":"NjUPtzESqi"},{"type":"text","value":" of the data. For example, we can tell our\nDataArray the name, values, and units of each dimension. In this case,\nin our case one dimension is “time” so we can label it as such.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"BWfh2FXhoc"}],"key":"MvxCcBpJ8G"}],"key":"lYCdthTmAe"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def epochs_to_dataarray(epochs):\n    \"\"\"A simple function to convert an Epochs object to DataArray\"\"\"\n    da = xr.DataArray(\n    epochs._data,\n    dims=['epoch', 'channel', 'time'],\n    coords={\n        'time': ecog.times,\n        'channel': ecog.ch_names,\n        'epoch': range(ecog._data.shape[0])\n    },\n    name='Sample dataset',\n    attrs=dict(ecog.info)\n    )\n    return da","key":"vjVQSYSxRy"},{"type":"output","id":"GGpyAChkDCBECWzaAkLiB","data":[],"key":"zbjgC4QTZN"}],"key":"vsOmE0c8i3"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Just look at all the metadata that we were able to pack into the DataArray.\nAlmost all of MNE’s metadata fit nicely into ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"A6PsbahR9y"},{"type":"inlineCode","value":".attrs","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XLUj3j4K1A"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ibNASdFgLN"}],"key":"UAbykajXOQ"}],"key":"stN1ZiZX01"},{"type":"block","kind":"notebook-code","data":{"tags":["hide_output"]},"children":[{"type":"code","lang":"python","executable":true,"value":"# There's quite a lot of output, so keep scrolling down!\nda = epochs_to_dataarray(ecog)\nda","visibility":"show","key":"F2DSR0468X"},{"type":"output","id":"PPYUNT2RsR3JWUJPG51QS","data":[{"output_type":"execute_result","execution_count":22,"metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"a760fe95ea5bfe6bf4775eed437092ce","path":"/build/a760fe95ea5bfe6bf4775eed437092ce.html"},"text/plain":{"content":"<xarray.DataArray 'Sample dataset' (epoch: 29, channel: 32, time: 2250)>\narray([[[-118.10999298, -121.30046844, -117.64116669, ...,\n           20.78869057,   11.38018703,    8.12319088],\n        [-126.95540619, -120.84265137, -105.75999451, ...,\n           25.57149315,   28.6223793 ,   24.82316971],\n        [ -28.1061306 ,  -16.39686775,  -21.64873505, ...,\n          -31.78049469,  -24.28160286,  -25.21776772],\n        ...,\n        [  18.55451965,   22.87419701,   25.66038895, ...,\n           25.84903336,   19.71798515,   14.92882633],\n        [ -44.79590607,  -49.5848465 ,  -52.08906555, ...,\n          -48.92469025,  -54.11177826,  -60.23026276],\n        [-105.09076691, -108.88887024, -113.57571411, ...,\n           -3.28264022,    5.5660615 ,   13.18798733]],\n\n       [[  20.84839821,   18.30262566,   20.12442017, ...,\n          -19.40711594,  -18.51371574,  -20.21596718],\n        [  18.0386982 ,    5.35804272,   -6.45382166, ...,\n          -42.1801033 ,  -44.59093857,  -47.80654144],\n        [  76.62892914,   73.66176605,   64.21563721, ...,\n          -12.31007576,  -21.26686478,  -26.83379555],\n        ...,\n        [  58.06867599,   53.49727631,   51.89107895, ...,\n           42.84626007,   52.36317062,   55.75439453],\n        [ -24.79452324,  -18.58691406,   -8.12459183, ...,\n          -45.95447159,  -42.66623306,  -41.06335449],\n        [-110.1750946 , -101.40830994,  -88.24209595, ...,\n          -26.7741375 ,  -32.31249619,  -37.07465744]],\n\n       [[  44.85819626,   57.10462952,   68.87900543, ...,\n           13.73396015,   28.33650208,   40.76254654],\n        [  10.10721684,   19.94246101,   31.81379509, ...,\n          120.01114655,  119.50100708,  128.0358429 ],\n        [ -96.35434723,  -89.9883194 ,  -72.41400909, ...,\n          140.28143311,  131.52635193,  133.30158997],\n        ...,\n        [   1.81244755,   -1.55214143,   -2.54425907, ...,\n          -30.9526062 ,  -31.50832367,  -32.25312042],\n        [  44.95462799,   38.7992363 ,   33.4192009 , ...,\n           64.5262146 ,   62.74245834,   61.11261368],\n        [ -37.66891861,  -37.9514122 ,  -40.97248077, ...,\n           61.204319  ,   58.57411194,   56.27007675]],\n\n       ...,\n\n       [[  88.75709534,   83.42398071,   76.10377502, ...,\n          -23.7650528 ,  -23.43914986,  -19.55894852],\n        [  63.89505005,   63.79450226,   61.43893433, ...,\n          -54.35200119,  -59.907547  ,  -69.36830139],\n        [  39.31270599,   46.15828705,   51.12403107, ...,\n          -30.19447899,  -27.1382637 ,  -19.75760651],\n        ...,\n        [  -2.09485602,  -13.05238819,  -19.73264503, ...,\n          150.31195068,  129.28895569,  114.28322601],\n        [-142.40054321, -142.72599792, -140.20773315, ...,\n           90.81705475,   82.73035431,   77.06429291],\n        [-161.34713745, -160.04364014, -151.092453  , ...,\n          238.87109375,  230.41633606,  222.64045715]],\n\n       [[  67.85353088,   72.97834778,   70.99682617, ...,\n           99.13801575,   95.14775085,   86.59616089],\n        [ 169.86994934,  172.12055969,  173.22143555, ...,\n          132.95147705,  135.66346741,  141.64862061],\n        [  80.4973526 ,   77.63601685,   73.43898773, ...,\n           91.37036896,   84.76886749,   82.48825836],\n        ...,\n        [ -13.24606895,   -8.65564728,    6.53395557, ...,\n         -105.62326813, -104.58720398, -107.99065399],\n        [  22.20972443,   49.33536148,   85.349823  , ...,\n         -103.54721069, -102.84375   , -104.26371002],\n        [ -33.03855133,   -9.5574255 ,   10.97984695, ...,\n         -148.20103455, -148.95999146, -154.4241333 ]],\n\n       [[ -98.52385712,  -99.22042847,  -99.56749725, ...,\n           49.72173309,   41.6667099 ,   31.01161194],\n        [ -70.90259552,  -66.83739471,  -68.66448975, ...,\n           35.73180008,   33.55708694,   28.1260643 ],\n        [ -29.78354645,  -34.5358963 ,  -40.23687363, ...,\n          -39.39603043,  -42.75005341,  -50.70994186],\n        ...,\n        [ 110.57292175,  103.35498047,   95.09171295, ...,\n         -162.01602173, -164.45585632, -168.76620483],\n        [  38.4355278 ,   39.19929504,   43.87767792, ...,\n         -108.41282654, -106.09828949, -103.17415619],\n        [  98.9158783 ,  105.16780853,  116.0725174 , ...,\n         -105.856987  , -105.39962769, -102.4755249 ]]])\nCoordinates:\n  * time     (time) float64 -1.5 -1.497 -1.493 -1.49 ... 5.987 5.99 5.993 5.997\n  * channel  (channel) <U5 'ch_0' 'ch_1' 'ch_2' ... 'ch_29' 'ch_30' 'ch_31'\n  * epoch    (epoch) int64 0 1 2 3 4 5 6 7 8 9 ... 19 20 21 22 23 24 25 26 27 28\nAttributes:\n    file_id:             {'version': 65539, 'machid': array([808661043, 80866...\n    events:              []\n    hpi_results:         []\n    hpi_meas:            []\n    subject_info:        None\n    device_info:         None\n    helium_info:         None\n    hpi_subsystem:       None\n    proc_history:        []\n    meas_id:             {'version': 65539, 'machid': array([808661043, 80866...\n    experimenter:        None\n    description:         None\n    proj_id:             None\n    proj_name:           None\n    meas_date:           (0, 0)\n    utc_offset:          None\n    sfreq:               300.0\n    highpass:            0.0\n    lowpass:             500.0\n    line_freq:           None\n    gantry_angle:        None\n    chs:                 [{'scanno': 1, 'logno': 1, 'kind': 902, 'range': 1.0...\n    dev_head_t:          <Transform  |  MEG device->head>\\n[[1. 0. 0. 0.]\\n [...\n    ctf_head_t:          None\n    dev_ctf_t:           None\n    dig:                 []\n    bads:                []\n    ch_names:            ['ch_0', 'ch_1', 'ch_2', 'ch_3', 'ch_4', 'ch_5', 'ch...\n    nchan:               32\n    projs:               []\n    comps:               []\n    acq_pars:            None\n    acq_stim:            None\n    custom_ref_applied:  False\n    xplotter_layout:     None\n    kit_system_id:       None","content_type":"text/plain"}}}],"visibility":"show","key":"eqReWbcqWQ"}],"visibility":"show","key":"XihBSkejLF"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"The data consists of many trials, channels, and timepoints.\nLet’s start by selecting a time region within each trial that\nwe can visualize more cleanly.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Du0gDBBgKi"}],"key":"mahnbBq7Bs"},{"type":"heading","depth":2,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Subsetting out data with ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"xA6h6t98bS"},{"type":"inlineCode","value":"da.sel","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Q0VeIHq46I"}],"identifier":"subsetting-out-data-with-da-sel","label":"Subsetting out data with da.sel","html_id":"subsetting-out-data-with-da-sel","implicit":true,"key":"h8PYXBeO8K"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"In xarray, we select items with the ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Efif7XJKBP"},{"type":"inlineCode","value":"sel","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"soFX7XlAtc"},{"type":"text","value":" and ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"uuh5n6WftQ"},{"type":"inlineCode","value":"isel","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"s3oWRC1W0b"},{"type":"text","value":" method. This\nbehaves kind of like the pandas ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"vEKxgbZ3zM"},{"type":"inlineCode","value":"loc","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"YqkG7ApP0e"},{"type":"text","value":" and ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"p18RdEDpNu"},{"type":"inlineCode","value":"iloc","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"wK3LbNKeUo"},{"type":"text","value":" methods, however\nbecause we have named dimensions, we can directly specify them in\nour call.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"KZgBvrPVb1"}],"key":"YX73G7hFK3"}],"key":"kUAwdbB3wW"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# We'll drop a subset of timepoints for visualization\nda = da.sel(time=slice(-1, 3))","key":"NO0nY9RzGA"},{"type":"output","id":"CJ-UnCl4G2fidVrn4O7Ep","data":[],"key":"yrd96ENS5w"}],"key":"cb4j72hQPG"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Now let’s calculate the average across all epochs for each electrode/time point.\nThis is a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XKCbgpxynK"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"reduction","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"M14kdRp4F3"}],"key":"D2g6e3tdko"},{"type":"text","value":" of our data array, in that it reduces the number of dimensions.\nXarray has many of the same statistical methods that NumPy does. An interesting\ntwist is that you can specify named dimensions instead of simply an ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kBitlU95Kg"},{"type":"inlineCode","value":"axis=<integer>","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"OovbhNfZzn"},{"type":"text","value":"\nargument. In addition, we’ll choose the colors that we’ll use for cycling through\nour channels - because we can quickly reference the channels axis by name, we don’t\nneed to remember which axis corresponds to channels.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JYLGGZTm1w"}],"key":"tII7RPoFUh"}],"key":"gNT2VYclxJ"},{"type":"block","kind":"notebook-code","data":{"tags":["full_width"]},"children":[{"type":"code","lang":"python","executable":true,"value":"fig, ax = plt.subplots(figsize=(15, 5))\nn_channels = da['channel'].shape[0]\nax.set_prop_cycle(color=plt.cm.viridis(np.linspace(0, 1, n_channels)))\nda.mean(dim='epoch').plot.line(x='time', hue='channel')\nax.get_legend().remove()","visibility":"show","key":"jZjOKxyAQu"},{"type":"output","id":"wdbqJA63od6e-Y48MrquQ","data":[{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"d2a005471e8a3037ad4047456d195f42","path":"/build/d2a005471e8a3037ad4047456d195f42.png"},"text/plain":{"content":"<Figure size 1080x360 with 1 Axes>","content_type":"text/plain"}}}],"visibility":"show","key":"ilFbAFqkxc"}],"visibility":"show","key":"xo73yhJR7p"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"It doesn’t look like much is going on...let’s see if we can clean it up a bit.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rZ7YLnoXb3"}],"key":"HWSBpxGEQg"}],"key":"r7k9IJ9vH7"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"De-meaning the data with ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"g2H4L2BZoK"},{"type":"inlineCode","value":"da.where","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MU39Al4o1d"}],"identifier":"de-meaning-the-data-with-da-where","label":"De-meaning the data with da.where","html_id":"de-meaning-the-data-with-da-where","implicit":true,"key":"vGXsbZ0qvH"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"First off - we’ll subtract the “pre-baseline mean” from each trial.\nThis makes it easier to visualize how each channel’s activity ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"BNrWCObu0j"},{"type":"emphasis","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"changed","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"FVEDzJiABE"}],"key":"U8dtNeEA90"},{"type":"text","value":"\nat time == 0.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"wQGeRH6UUX"}],"key":"Vxa7XV0NN9"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"To accomplish this we’ll use ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"TUwFgDJKRq"},{"type":"inlineCode","value":"da.where","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"drcgz6674S"},{"type":"text","value":". This takes some kind of\nboolean-style mask, does a bunch of clever projections according to the\nnames of coordinates, and returns the dataarray masked values removed\n(as ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"x3EWRS0PTn"},{"type":"inlineCode","value":"NaN","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"OYBmTWaPLD"},{"type":"text","value":"s) and other values unchanged. We can use this to calculate the\nmean of each channel / epoch ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"eDRS6Z1DC9"},{"type":"emphasis","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"only for the pre-baseline timepoints","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"u66YSq0pdm"}],"key":"zYFMBJEjEj"},{"type":"text","value":".","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"A4vac17pbB"}],"key":"FhwXbylkAS"}],"key":"jrbEBO3NcT"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# This returns a version of the data array with NaNs where the query is False\n# The dimensions will intelligently broadcast \nprebaseline_mean = da.where(da.time < 0).mean(dim='time')\nda_demeaned = da - prebaseline_mean","key":"f5kn1N8uLY"},{"type":"output","id":"GTRxHWyl0-9NNQ8K4ZKaK","data":[],"key":"xCOjJQJ5d6"}],"key":"m3rISeHzBN"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now we can visualize the de-baseline-meaned data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rLXDKcIFnX"}],"key":"M1J6Ny4PsY"}],"key":"Yf5O7YuCNa"},{"type":"block","kind":"notebook-code","data":{"tags":["full_width"]},"children":[{"type":"code","lang":"python","executable":true,"value":"fig, ax = plt.subplots(figsize=(15, 5))\nax.set_prop_cycle(color=plt.cm.viridis(np.linspace(0, 1, da['channel'].shape[0])))\nda_demeaned.mean(dim='epoch').plot.line(x='time', hue='channel')\nax.get_legend().remove()","visibility":"show","key":"G54wF9FaAp"},{"type":"output","id":"j7BF9O2hj-CA6dJH0x8tI","data":[{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"353af84f275a78ecad4d82e77d4e808b","path":"/build/353af84f275a78ecad4d82e77d4e808b.png"},"text/plain":{"content":"<Figure size 1080x360 with 1 Axes>","content_type":"text/plain"}}}],"visibility":"show","key":"BkXxFTq9jz"}],"visibility":"show","key":"yAbFBF4Tj0"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Hmmm, there still doesn’t seem to be much going on (that channel down\nat the bottom looks noisy to me, rather than having a meaningful signal)\nso let’s transform this signal into something with a bit more SNR to it.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jCauQCJT5y"}],"key":"APDvjezjpw"}],"key":"pvT8nTuPkz"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Extracting a more useful feature with ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jhG189Zl1A"},{"type":"inlineCode","value":"xr.apply_ufunc","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mnt3naAAqU"}],"identifier":"extracting-a-more-useful-feature-with-xr-apply-ufunc","label":"Extracting a more useful feature with xr.apply_ufunc","html_id":"extracting-a-more-useful-feature-with-xr-apply-ufunc","implicit":true,"key":"oHthFueq7R"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"Without going into too much details on the neuroscience, iEEG data is\nparticularly useful because there is information about neuronal activity in\nthe higher frequency parts of the signal (AKA, parts of the electrical signal that\nchange very quickly, but have very low amplitude). To pull that out, we’ll do the following:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"v8ZLrpxyjf"}],"key":"QKwVPdaWdk"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":8,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"High-pass filter the signal, which will remove all the slow-moving components","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"Ae9LvocdBD"}],"key":"BzorjrRQfd"}],"key":"eVg6Ip2auG"},{"type":"listItem","spread":true,"position":{"start":{"line":9,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Calculate the ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"OQj1AdZr44"},{"type":"emphasis","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"envelope","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"jX9y1z4W4j"}],"key":"mIrYi1ZMdr"},{"type":"text","value":" of the signal, which will tell us the power of\nhigh-frequency activity over time.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"rLjIx2uF3b"}],"key":"AzWXgydF6W"}],"key":"mMf2pAwdWj"}],"key":"ufDHRSwGPj"},{"type":"heading","depth":3,"position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"High-pass filtering the signal","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"gq6rW6eZAs"}],"identifier":"high-pass-filtering-the-signal","label":"High-pass filtering the signal","html_id":"high-pass-filtering-the-signal","implicit":true,"key":"nMVq9SBZgG"},{"type":"paragraph","position":{"start":{"line":14,"column":1},"end":{"line":18,"column":1}},"children":[{"type":"text","value":"MNE has a lot of nice functions for filtering a timeseries. Most of these\noperate on numpy arrays instead of MNE objects. We’ll use\nxarray’s ","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"roHaC53hxG"},{"type":"inlineCode","value":"apply_ufunc","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"mMlFhvTJO1"},{"type":"text","value":" function to simply map that function onto our dataarray.\nxarray should keep track of the metadata (e.g. coordinates etc) and output a\nnew DataArray with updated values.","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"rotTLcXxYe"}],"key":"t7FRRgL23y"}],"key":"TWRbOHdppO"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"flow = 80\nfhigh = 140\nda_lowpass = xr.apply_ufunc(\n    mne.filter.filter_data, da,\n   kwargs=dict(\n       sfreq=da.sfreq,\n       l_freq=flow,\n       h_freq=fhigh,\n   )\n)","key":"d1tEGmZevx"},{"type":"output","id":"itbnYd6-HNlEn8Tx-OXkG","data":[{"name":"stdout","output_type":"stream","text":"Setting up band-pass filter from 80 - 1.4e+02 Hz\n\nFIR filter parameters\n---------------------\nDesigning a one-pass, zero-phase, non-causal bandpass filter:\n- Windowed time-domain design (firwin) method\n- Hamming window with 0.0194 passband ripple and 53 dB stopband attenuation\n- Lower passband edge: 80.00\n- Lower transition bandwidth: 20.00 Hz (-6 dB cutoff frequency: 70.00 Hz)\n- Upper passband edge: 140.00 Hz\n- Upper transition bandwidth: 10.00 Hz (-6 dB cutoff frequency: 145.00 Hz)\n- Filter length: 99 samples (0.330 sec)\n\n"}],"key":"yKiLb3pMXt"}],"key":"XpZwxtfXog"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Visualizing our data, we can see all the slower fluctuations (e.g. long arcs over time)\nare gone.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Chuto2YETI"}],"key":"F8lEJUH8Yd"}],"key":"I3ftQHr4oz"},{"type":"block","kind":"notebook-code","data":{"tags":["full_width"]},"children":[{"type":"code","lang":"python","executable":true,"value":"fig, ax = plt.subplots(figsize=(15, 5))\nda_lowpass.mean(dim='epoch').plot.line(x='time')\nax.get_legend().remove()","visibility":"show","key":"oz22JNo29X"},{"type":"output","id":"oITD3u1-eifMs2inB8JG9","data":[{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"8d4f3353e4f30638468ea9b2683d3bb4","path":"/build/8d4f3353e4f30638468ea9b2683d3bb4.png"},"text/plain":{"content":"<Figure size 1080x360 with 1 Axes>","content_type":"text/plain"}}}],"visibility":"show","key":"qmrHuWQFLL"}],"visibility":"show","key":"PTzivW16SY"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Calculate the envelope of this signal with ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"xHs653u1Rn"},{"type":"inlineCode","value":"da.groupby","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"m9BEQY30QR"}],"identifier":"calculate-the-envelope-of-this-signal-with-da-groupby","label":"Calculate the envelope of this signal with da.groupby","html_id":"calculate-the-envelope-of-this-signal-with-da-groupby","implicit":true,"key":"CwQqfSg5Dz"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Next, we’ll calculate the ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"bRW3evvkAu"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"envelope","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"zPFtITkKTU"}],"key":"k2vQDtF41z"},{"type":"text","value":" of the high-pass-filtered data. This is roughly\nthe ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"PpRPonr5Fe"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"power","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Ij3czJwOvY"}],"key":"wA9bywN3fb"},{"type":"text","value":" that is present in these high frequencies over time. We do so by using\nsomething called a ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"KvZT0JgcPQ"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"hilbert transform","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"IiSJElwbSe"}],"key":"kXUmM3En9x"},{"type":"text","value":".","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"UedwIOqiq1"}],"key":"ameWGFVF1u"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"MNE also has a function for applying Hilbert transforms to data, but it has a weird quirk\nthat expects the data to be of a particular shape. We can work around this by using our\nDataArray’s ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"sDByrhgtKF"},{"type":"inlineCode","value":"groupby","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"CfxhhuaJIJ"},{"type":"text","value":" method. This works similar to ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"RKI90xmntI"},{"type":"inlineCode","value":"DataFrame.groupby","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"EFLkCpMRKE"},{"type":"text","value":" - we’ll iterate\nthrough each channel, which will return a DataArray with shape ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"a1gFPhMyA8"},{"type":"inlineCode","value":"epochs x timepoints","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"UNXOhxxBlp"},{"type":"text","value":".\nWe can then calculate the Hilbert transform in each and re-combine into the original shape.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"LiCZdNTgmj"}],"key":"sC10tJfLvK"}],"key":"mjfbNB3Av7"},{"type":"block","kind":"notebook-content","data":{"tags":["popout"]},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Note","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Pq8pASkLlb"}],"key":"C0fl0mRxHH"},{"type":"text","value":": This can be an expensive operation depending on the number of channels/epochs and\nthe length of each trial. This might be a good place to insert paralellization via Dask.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"avAx5ehaQE"}],"key":"eXPE6EgAHp"}],"visibility":"show","key":"NSOxZ8cGL4"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"def hilbert_2d(array):\n    \"\"\"Perform a Hilbert transforms on an (n_channels, n_times) array.\"\"\"\n    for ii, channel in enumerate(array):\n        array[ii] = mne.filter._my_hilbert(channel, envelope=True)\n    return array\n\nda_hf_power = da_lowpass.groupby(da.coords['epoch']).apply(hilbert_2d)","key":"phCKQyADez"},{"type":"output","id":"pV8wnaIqxti_BAJ02nbgb","data":[],"key":"tU6D5ktLWT"}],"key":"MfwAwoesPR"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"The output dataarray should be the exact same shape, because we haven’t done any dimensional reductions.\nIf we take a look at the resulting data, we can see what seems to be more structure in there:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"IqgdUB9YmM"}],"key":"yDQYE52q2j"}],"key":"qZGYOl3ddH"},{"type":"block","kind":"notebook-code","data":{"tags":["full_width"]},"children":[{"type":"code","lang":"python","executable":true,"value":"fig, ax = plt.subplots(figsize=(15, 5))\nda_hf_power.mean(dim='epoch').plot.line(x='time', hue='channel')\nax.get_legend().remove()","visibility":"show","key":"KgbzfCtIGt"},{"type":"output","id":"ULnAQPyz_56F0c6XdLSS4","data":[{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"bd0b6ea1aadfee7a494630159662ad6b","path":"/build/bd0b6ea1aadfee7a494630159662ad6b.png"},"text/plain":{"content":"<Figure size 1080x360 with 1 Axes>","content_type":"text/plain"}}}],"visibility":"show","key":"G9n9qNlyST"}],"visibility":"show","key":"Dvn764ttFL"},{"type":"block","kind":"notebook-content","data":{"toc-hr-collapsed":false},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Cleaning up our HFA data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PAYpZsYcwA"}],"identifier":"cleaning-up-our-hfa-data","label":"Cleaning up our HFA data","html_id":"cleaning-up-our-hfa-data","implicit":true,"key":"CtHNRno5iY"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Next let’s clean up this high-frequency activity (HFA) data.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"xZGKQGSFmi"}],"key":"HMmZltJmnA"}],"key":"Ky8oSVN38S"},{"type":"block","kind":"notebook-content","data":{"toc-hr-collapsed":false},"children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Z-scoring our array","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"J1Fco080JE"}],"identifier":"z-scoring-our-array","label":"Z-scoring our array","html_id":"z-scoring-our-array","implicit":true,"key":"giQhNpB8dN"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"Instead of simple de-meaning\nthe data like before, we’ll ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"L6xjj0wxck"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"re-scale","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"V2FGwI3cOl"}],"key":"qOBr08Zueu"},{"type":"text","value":" our data using the same baseline timepoints.\nWhat we’d like to do is the following:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"juweKbudGG"}],"key":"E96cHAECU4"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":7,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Calculate the mean and standard deviation across trials of all pre-baseline data values, per channel","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"P96uM5hmQB"}],"key":"bAFw9d6yeK"}],"key":"Vu5T7qB48I"},{"type":"listItem","spread":true,"position":{"start":{"line":8,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"paragraph","children":[{"type":"text","value":"Z-score each channel using this mean and standard deviation","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"u7OtG2by75"}],"key":"AmcB8HxDlq"}],"key":"MtJTZfl549"}],"key":"RlQClfnXRq"},{"type":"paragraph","position":{"start":{"line":10,"column":1},"end":{"line":11,"column":1}},"children":[{"type":"text","value":"Once again we’ll use the groupby / apply combination to apply our function to subsets\nof the data.","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"htRUR8Z5Sc"}],"key":"JeEBGnpuTz"}],"key":"TxyMmKUkBc"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# For each channel, apply a z-score that uses the mean/std of pre-baseline activity for all trials\ndef z_score(activity):\n    \"\"\"Take a DataArray and apply a z-score using the baseline\"\"\"\n    baseline = activity.where(activity.time < -.1 )\n    return (activity - np.nanmean(baseline)) / np.nanstd(baseline)\n\nda_hf_zscored = da_hf_power.groupby('channel').apply(z_score)","key":"R8JUce3JHx"},{"type":"output","id":"z-dHVXfdtjivu-EYRw0Wp","data":[],"key":"yaNUFrDyF5"}],"key":"oLemxIyCD4"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Taking a look at the result, we can see a much cleaner separation of activity for\nsome of the channels after ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pJOGUNhkac"},{"type":"inlineCode","value":"time==0","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ODp6yOD4vm"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"z4ecPg6NpV"}],"key":"U4Vrja2gFq"}],"key":"xmlVeIiEiz"},{"type":"block","kind":"notebook-code","data":{"tags":["full_width"]},"children":[{"type":"code","lang":"python","executable":true,"value":"fig, ax = plt.subplots(figsize=(15, 5))\nda_hf_zscored.mean(dim='epoch').plot.line(x='time', hue='channel')\nax.get_legend().remove()","visibility":"show","key":"UkBVW1l2cX"},{"type":"output","id":"hDflaJxlyVascTf4LER2P","data":[{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"6fa8536695567fa2cfa95d3ab343e1a2","path":"/build/6fa8536695567fa2cfa95d3ab343e1a2.png"},"text/plain":{"content":"<Figure size 1080x360 with 1 Axes>","content_type":"text/plain"}}}],"visibility":"show","key":"ulHDMNCpO6"}],"visibility":"show","key":"iVDtkUCPzV"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Smoothing our HFA data","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jJe9FtCuzR"}],"identifier":"smoothing-our-hfa-data","label":"Smoothing our HFA data","html_id":"smoothing-our-hfa-data","implicit":true,"key":"jzyTR9RJJz"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Finally, let’s smooth this HFA so it has less jitter to it, and pick a smaller window that\nremoves some of the filtering artifacts at the edges.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"yh0p4M9FDi"}],"key":"WgjEf0DYGp"},{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"We’ll use the same ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"h8uTkcxM6t"},{"type":"inlineCode","value":"filter_data","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"obmSUcdtKg"},{"type":"text","value":" function as before, but this time\napplied with the ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"AZ5UuW0IBT"},{"type":"inlineCode","value":".groupby","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"zRVtrNHRYI"},{"type":"text","value":" and ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"juRdmkv8O4"},{"type":"inlineCode","value":".apply","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"ZFjmosxL8W"},{"type":"text","value":" combination to show two ways\nof accomplishing the same thing. We’ll also use ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"lObkblQr1I"},{"type":"inlineCode","value":".sel","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"Ego7s5XF3G"},{"type":"text","value":" to pick a subset\nof time for visualization","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"t0ZM81ynY8"}],"key":"a3oI9G9fFF"}],"key":"KTwjArcQH2"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"da_hf_zscored_lowpass = da_hf_zscored.groupby('epoch').apply(\n    mne.filter.filter_data,\n    sfreq=da.sfreq,\n    l_freq=None,\n    h_freq=10,\n    verbose=False\n)","key":"VwJk7W2pB2"},{"type":"output","id":"MXkLmFOrCX1SKXKOm0rzG","data":[],"key":"CeoXJUOABw"}],"key":"ob5HMMpTFZ"},{"type":"block","kind":"notebook-content","data":{"tags":["popout"]},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"Note that quickly selecting a subset of timepoints if we used numpy is much more verbose. Here’s\na quick comparison:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Mo3uphtdkb"}],"key":"qeIkjSyW8M"},{"type":"code","lang":"python","value":"# Numpy alone\nmask_time = (times > -.8) * (times < 2.8)\nepoch_dim = 0\nda_hf_zscored_lowpass[..., mask_time].mean(epoch_dim)\n\n# xarray\nda_hf_zscored_lowpass.sel(time=slice(-.8, 2.8)).mean(dim='epoch')","position":{"start":{"line":4,"column":1},"end":{"line":12,"column":1}},"key":"azEitt1jOC"}],"visibility":"show","key":"jVHnfHdCSf"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"fig, ax = plt.subplots(figsize=(15, 5))\nda_hf_zscored_lowpass.mean(dim='epoch').sel(time=slice(-.8, 2.8)).plot.line(x='time', hue='channel')\nax.get_legend().remove()","key":"z2dDlNgbXM"},{"type":"output","id":"cpdpGSAAwGuY75q7Smkfv","data":[{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"a1097f62a3a45fd41be89555a8d5333c","path":"/build/a1097f62a3a45fd41be89555a8d5333c.png"},"text/plain":{"content":"<Figure size 1080x360 with 1 Axes>","content_type":"text/plain"}}}],"key":"p3XQUSpsP7"}],"key":"sc8ha5N9lp"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Now we can see there are clearly some channels that become active just after ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ms7bz1u5ZM"},{"type":"inlineCode","value":"t==0","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"N3X1sfuWFv"},{"type":"text","value":".\nWe can reduce our dataarray to a single dimension of “mean post-baseline activity in each channel”\nand convert it to a DataFrame for further processing:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WT2bIBKHP4"}],"key":"MHPkqCOgAN"}],"key":"U1OChdnZMZ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Find the channel with the most activity by first converting to a dataframe\ntotal_activity = da_hf_zscored_lowpass.sel(time=slice(0, 2)).mean(dim=['epoch', 'time'])\ntotal_activity = total_activity.to_dataframe()\ntotal_activity.head()","key":"eq4q4N6gfi"},{"type":"output","id":"3ztMuV7ypACDgc4j3Ik9l","data":[{"output_type":"execute_result","execution_count":35,"metadata":{},"data":{"text/html":{"content":"<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>Sample dataset</th>\n    </tr>\n    <tr>\n      <th>channel</th>\n      <th></th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>ch_0</th>\n      <td>0.011101</td>\n    </tr>\n    <tr>\n      <th>ch_1</th>\n      <td>0.012152</td>\n    </tr>\n    <tr>\n      <th>ch_2</th>\n      <td>0.051911</td>\n    </tr>\n    <tr>\n      <th>ch_3</th>\n      <td>0.176188</td>\n    </tr>\n    <tr>\n      <th>ch_4</th>\n      <td>0.246021</td>\n    </tr>\n  </tbody>\n</table>\n</div>","content_type":"text/html"},"text/plain":{"content":"         Sample dataset\nchannel                \nch_0           0.011101\nch_1           0.012152\nch_2           0.051911\nch_3           0.176188\nch_4           0.246021","content_type":"text/plain"}}}],"key":"N8qQTsV9Bw"}],"key":"xqL5HFB5vn"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Let’s grab the channel with maximal activation to look into a bit further.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"b8qdDPO7K0"}],"key":"hbYXnV0tEF"}],"key":"WVt68xndLU"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"max_chan = total_activity.squeeze().sort_values(ascending=False).index[0]","key":"wMBWhQt48H"},{"type":"output","id":"4GXtQ2lDGhEHck-QrqGwz","data":[],"key":"yDmiHvUCiC"}],"key":"GXJiOT8rNG"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Time frequency analysis","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mJ4ZHO1Juo"}],"identifier":"time-frequency-analysis","label":"Time frequency analysis","html_id":"time-frequency-analysis","implicit":true,"key":"hg9KJufi62"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"As a final step, let’s ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"PgqHyEMyJd"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"expand","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ItvpMwPqQe"}],"key":"iAiWV2cveY"},{"type":"text","value":" our DataArray and add another dimension.\nIn the above steps we specifically focused on high-frequency activity. A more\ncommon approach is to first create a ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"XJB7UkZP9w"},{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"spectrogram","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ryk00lZlMH"}],"key":"F3Wl7xhAXZ"},{"type":"text","value":" of your data to see activity\nacross many frequencies.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"PgKTcerGHn"}],"key":"qHXyIkORPG"},{"type":"paragraph","position":{"start":{"line":8,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"text","value":"To do this, we’ll use another MNE function for creating a ","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"LD9fVIw9t5"},{"type":"strong","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Time-Frequency Representation","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"BaJtf9kmaB"}],"key":"Olg7PaoRab"},{"type":"text","value":"\nor TFR. We’ll define a range of frequencies, and apply MNE’s function ","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"w1DKQKqLvk"},{"type":"emphasis","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"directly on our DataArray","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"Agb3RAlRd0"}],"key":"G8PbwKuwDO"},{"type":"text","value":".\nThis will return a NumPy array with the filtered values.","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"wlKeZzw8i7"}],"key":"gx0lWD2rND"}],"key":"dgjSVW3A7O"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"frequencies = [2**ii for ii in np.arange(2, 9, .5)]\ntfr = mne.time_frequency.tfr_array_morlet(\n    da,\n    sfreq=da.sfreq,\n    freqs=frequencies,\n    n_cycles=4,\n)\n\n# Take the absolute value to throw out the non-real parts of the numbers\ntfr = np.abs(tfr)\ntfr[:2, :2, :2, :2]","key":"joEQAyVczY"},{"type":"output","id":"ulUz9vTbsVuJzszeCgLc3","data":[{"output_type":"execute_result","execution_count":37,"metadata":{},"data":{"text/plain":{"content":"array([[[[160.04103045, 160.38413909],\n         [171.73704543, 175.09249553]],\n\n        [[283.28699104, 285.21855726],\n         [241.65630528, 245.77098295]]],\n\n\n       [[[ 93.99546124,  94.4406537 ],\n         [ 78.02050045,  79.15324341]],\n\n        [[ 47.85148993,  49.90845151],\n         [ 53.97221461,  54.55793674]]]])","content_type":"text/plain"}}}],"key":"Y1EI60voth"}],"key":"hoHR6GD5cg"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":3,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Convert this data into a DataArray with ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aQ0d407oNO"},{"type":"inlineCode","value":".expand_dims","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BfuEU1w7FT"}],"identifier":"convert-this-data-into-a-dataarray-with-expand-dims","label":"Convert this data into a DataArray with .expand_dims","html_id":"convert-this-data-into-a-dataarray-with-expand-dims","implicit":true,"key":"a2YPNU4qou"}],"key":"kmyRUvk6Gt"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Next, we’ll convert this into a DataArray by using the metadata from our original\nDataArray. We can use the ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uicKS8gJZl"},{"type":"inlineCode","value":"expand_dims","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"mH2YDbhclC"},{"type":"text","value":" method to create a new dimension for our DataArray.\nWe’ll use this to store frequency information.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"JW7EAP9nTF"}],"key":"khfDyLCPwi"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"We’ll then reshape our new DataArray so that it matches the output of the MNE function,\nand use the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"rFK729Sqw5"},{"type":"inlineCode","value":"copy","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"v4tMgyJanX"},{"type":"text","value":" method to create a new DataArray. By supplying the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"XpYXuxe9pR"},{"type":"inlineCode","value":"data=","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"tKzLKz64IS"},{"type":"text","value":" argument\nto copy, we directly insert the new data inside the generated DataArray.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"uszgBhCB8K"}],"key":"jIzxAHSEng"}],"key":"di356zrVFX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"da_tfr = (da\n    .expand_dims(frequency=frequencies)\n    .transpose('epoch', 'channel', 'frequency', 'time')\n    .copy(data=np.log(tfr))\n)","key":"yfjBeJqZFr"},{"type":"output","id":"cehE_ImCibMNlbVZYFUZr","data":[],"key":"BTDgXmyhbu"}],"key":"nJ9I3m8kIe"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We can now visualize this time-frequency representation over time","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"vav3sjqmUJ"}],"key":"Vl8AlcPgma"}],"key":"IKn80Mh2eU"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"fig, ax = plt.subplots(figsize=(15, 5))\n(da_tfr\n    .sel({'frequency': slice(None, 180), 'channel': max_chan})\n    .mean('epoch')\n    .plot.imshow(x='time', y='frequency')\n)","key":"Z1vrN2npus"},{"type":"output","id":"F3OoVGcWez_M790FVHDC1","data":[{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"3d6257be54ef134bc9b4e2ea4ab2d85d","path":"/build/3d6257be54ef134bc9b4e2ea4ab2d85d.png"},"text/plain":{"content":"<Figure size 1080x360 with 2 Axes>","content_type":"text/plain"}}}],"key":"mnY1rCuzqU"}],"key":"jcEb9PNcBA"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Similar to our one-dimensional visualizations above, it can be hard to visualize\nrelative changes in activity over a baseline (particularly because the amplitude scales\ninversely with the frequency).","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aGoGCtOAjA"}],"key":"M1QXrlkEHW"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Let’s apply a re-scaling function to our data so that\nwe can see things more clearly. This time we’ll use MNE’s ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"Qn6maNLXsV"},{"type":"inlineCode","value":"rescale","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"OpUOfKy3h4"},{"type":"text","value":" function, which\nacts similarly to our ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"PqRRb6xNsi"},{"type":"inlineCode","value":"zscore","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"KUOYuv0nkZ"},{"type":"text","value":" function above.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"VZ2mU6DABi"}],"key":"Ymt3fa8JiR"}],"key":"iQJwof7W7r"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"da_tfr_baselined = xr.apply_ufunc(\n    mne.baseline.rescale,\n    da_tfr,\n    kwargs={'times': da_tfr.coords['time'], 'baseline': (None, -.1), \"mode\": 'zscore'}\n)","key":"aQQWg3Rqit"},{"type":"output","id":"-FmBSnh7p0sAgYQs-4H7p","data":[{"name":"stdout","output_type":"stream","text":"Applying baseline correction (mode: zscore)\n"}],"key":"qZ63o3faYI"}],"key":"mcQv8SKmz1"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"again, the result should be a DataArray, so we can directly visualize it:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fW2udFhBpw"}],"key":"zPXnlj9v7H"}],"key":"mUm3XzI6to"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"(da_tfr_baselined\n    .sel({'frequency': slice(None, 180), 'channel': max_chan, 'time': slice(-.8, 2.5)})\n    .mean('epoch')\n    .plot.imshow(x='time', y='frequency')\n)","key":"pXajpAc2pe"},{"type":"output","id":"dNYk8OQVD2e98f23tO4nA","data":[{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"0e4ee40776d84c7b267e77baf6850539","path":"/build/0e4ee40776d84c7b267e77baf6850539.png"},"text/plain":{"content":"<Figure size 432x288 with 2 Axes>","content_type":"text/plain"}}}],"key":"Y61l6BWvZy"}],"key":"qXVsdz00Kz"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now we can see a clear increase in activity in the higher frequencies at ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PKjSMAhfsN"},{"type":"inlineCode","value":"t==0","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AYtG5NWfy4"},{"type":"text","value":".","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bbx3nqvlUN"}],"key":"fi5oTCcwC3"}],"key":"R0kJFbxzYM"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Combining the two with ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HWcmejLSVw"},{"type":"inlineCode","value":"xr.merge","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PlvuO51k8G"}],"identifier":"combining-the-two-with-xr-merge","label":"Combining the two with xr.merge","html_id":"combining-the-two-with-xr-merge","implicit":true,"key":"N488rnm2O9"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"Finally, let’s combine these two DataArrays into one. We know that they\nshare much of the same metadata - the first is “Amplitude of High-Frequency Activity”\nand the second is “Time-frequency power”. We should be able to merge these\ninto a single xarray ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"e2sAhHBir1"},{"type":"inlineCode","value":"DataSet","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"WcAp0Si3l2"},{"type":"text","value":", which will allow us to perform operations across\nboth by using their shared dimensions. DataSets are kind of like collections of\nDataArrays, with assumptions that the DataArrays share some metadata or coordinates.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"P4zBRzLc24"}],"key":"OF77faW1q9"},{"type":"paragraph","position":{"start":{"line":10,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"First, we’ll rename each DataArray so that we can merge them nicely. Then, we’ll simply\nuse the ","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"jlYiHNGSO3"},{"type":"inlineCode","value":"xr.merge","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"WNP7bQYsaJ"},{"type":"text","value":" function, which tries to automatically figure out which dimensions are\nshared based on their names and coordinate values.","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"EfqQMcmdqe"}],"key":"BpgMvRYcSh"}],"key":"JaSJYaJ8gy"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"da_tfr_baselined.name = \"Time Frequency Representation\"\nda_hf_zscored_lowpass.name = \"Low-pass filtered HFA\"\nds = xr.merge([da_tfr_baselined, da_hf_zscored_lowpass])\nds","key":"UJ68bYaBey"},{"type":"output","id":"SiP77DL3Kp1G4vgoDwAbo","data":[{"output_type":"execute_result","execution_count":43,"metadata":{},"data":{"text/html":{"content_type":"text/html","hash":"c7a589cf576f3a807805fd4c44fb5444","path":"/build/c7a589cf576f3a807805fd4c44fb5444.html"},"text/plain":{"content":"<xarray.Dataset>\nDimensions:                        (channel: 32, epoch: 29, frequency: 14, time: 1201)\nCoordinates:\n  * frequency                      (frequency) float64 4.0 5.657 ... 256.0 362.0\n  * time                           (time) float64 -1.0 -0.9967 ... 2.997 3.0\n  * channel                        (channel) <U5 'ch_0' 'ch_1' ... 'ch_31'\n  * epoch                          (epoch) int64 0 1 2 3 4 5 ... 24 25 26 27 28\nData variables:\n    Time Frequency Representation  (epoch, channel, frequency, time) float64 -1.068 ... 1.231\n    Low-pass filtered HFA          (epoch, channel, time) float64 -0.5572 ... -0.7839","content_type":"text/plain"}}}],"key":"WUkX1UQxzm"}],"key":"Cqz28WuaKK"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Since we’ve got a single dataset, we can grab subsets along each axis across both\nDataArrays at the same time. We’ll select a subset of channels, time, and frequency bands\nto visualize.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"WF6Y6TBOie"}],"key":"qozPTEzRmn"}],"key":"CFn2Z9eXIF"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ds_plt = ds.sel({'channel': max_chan, 'frequency': slice(10, 150), 'time': slice(-.5, 2)})","key":"m73lHUdlF2"},{"type":"output","id":"gxXsdoyRi9T_9KCVNTDqV","data":[],"key":"SyCtuwuiJv"}],"key":"CGC5KQL1BB"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Now, we’ll plot ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"gFPSTP4AIV"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"both","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"VVIHLf25NC"}],"key":"rvmi4apaHm"},{"type":"text","value":" the spectrogram and the HFA in the same Matplotlib figure. As you\ncan see, these plots contain somewhat redundant information. The top plot tells us that there is\na general increase in power for high-frequencies. The bottom plot gives us the average increase in\npower across the higher frequencies.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"eDJbfjwL4n"}],"key":"mhnIO3sI6Z"}],"key":"Zpmm70a9AG"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"fig, (ax_tfr, ax_hfa) = plt.subplots(2, 1, figsize=(15, 10))\nim = ds_plt['Time Frequency Representation'].mean('epoch').plot.imshow(x='time', y='frequency',\n                                                                       ax=ax_tfr)\n\nds_plt['Low-pass filtered HFA'].mean('epoch').plot.line(x='time', ax=ax_hfa)","key":"R8al3w9WYP"},{"type":"output","id":"TZYz49DrsGVA8qLhmwQ7l","data":[{"output_type":"display_data","metadata":{"needs_background":"light"},"data":{"image/png":{"content_type":"image/png","hash":"f08d3a3e82c20477112b56b792308c6f","path":"/build/f08d3a3e82c20477112b56b792308c6f.png"},"text/plain":{"content":"<Figure size 1080x720 with 3 Axes>","content_type":"text/plain"}}}],"key":"zFeb0qfDjD"}],"key":"KJrACJJk2Z"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Wrapping up","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"MprXP2D3ct"}],"identifier":"wrapping-up","label":"Wrapping up","html_id":"wrapping-up","implicit":true,"key":"DmyWfwDJdI"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"In all, I was pretty happy with what you can do using xarray’s ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"Su1y4d8ZCz"},{"type":"inlineCode","value":"DataArray","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"nNeJXjckYv"},{"type":"text","value":" structure.\nIt’s pretty nice to be able to refer to axes by their names, and to make more intelligent\nselection / slicing operations using their coordinate values. Moreover, this post is just\nscratching the surface for how to use this information in a way that speeds up the exploration\nand analysis post.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"cwP8Jh0313"}],"key":"miqW5ZbjFD"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"For example, we might have sped-up some feature extraction steps by using\na distributed processing framework like ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"KTKTmOB8zW"},{"type":"strong","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Dask","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"Ir6k9q4upB"}],"key":"fLaeWgScWW"},{"type":"text","value":" in the operations above. Dask integrates nicely\nwith xarray, and offers a lot of interesting opportunities to parallelize interactive computation.\nI’ll explore that in another blog post.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"swR7n9zdF4"}],"key":"RSBPdMQioW"},{"type":"paragraph","position":{"start":{"line":14,"column":1},"end":{"line":16,"column":1}},"children":[{"type":"text","value":"Finally - the goal of this post has largely been to learn a bit more about xarray. This means I might\nbe totally mis-using functionality, or missing something that would have made the above process much\neasier. If anybody has tips or thoughts on the code above, please do reach out!","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"OcpUGd3R8N"}],"key":"sq0pLTkUK8"}],"key":"Rhw6i4n86S"}],"key":"KHgc2J8zfn"},"references":{"cite":{"order":["Holdgraf_2017"],"data":{"Holdgraf_2017":{"label":"Holdgraf_2017","enumerator":"1","doi":"10.3389/fnsys.2017.00061","html":"Holdgraf, C. R., Rieger, J. W., Micheli, C., Martin, S., Knight, R. T., & Theunissen, F. E. (2017). Encoding and Decoding Models in Cognitive Electrophysiology. <i>Frontiers in Systems Neuroscience</i>, <i>11</i>. <a target=\"_blank\" rel=\"noreferrer\" href=\"https://doi.org/10.3389/fnsys.2017.00061\">10.3389/fnsys.2017.00061</a>","url":"https://doi.org/10.3389/fnsys.2017.00061"}}}},"footer":{"navigation":{"prev":{"title":"What would Rust-style governance look like in Jupyter?","url":"/blog/2019/2019-10-13-rust-jupyter-governance","group":"2019"},"next":{"title":"What would Python-style governance look like in Jupyter?","url":"/blog/2019/2019-10-27-jupyter-governance-python","group":"2019"}}},"domain":"http://localhost:3000"}