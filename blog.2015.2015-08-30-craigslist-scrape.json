{"kind":"Notebook","sha256":"19c6513ab4a28a98ae0347ba724ddf553cd14ed057bc3bc9cfdc367db1021f38","slug":"blog.2015.2015-08-30-craigslist-scrape","location":"/blog/2015/2015-08-30-craigslist_scrape.ipynb","dependencies":[],"frontmatter":{"title":"Scraping craigslist","tags":["python","programming"],"date":"2015-08-30","kernelspec":{"name":"python3","display_name":"Python 3 (ipykernel)","language":"python"},"content_includes_title":false,"github":"https://github.com/choldgraf/choldgraf.github.io","exports":[{"format":"ipynb","filename":"2015-08-30-craigslist_scrape.ipynb","url":"/build/2015-08-30-craigslis-8fb6b83af7d35eb8ec498b4656f840cd.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","children":[{"type":"heading","depth":2,"position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"children":[{"type":"text","value":"Overview","position":{"start":{"line":27,"column":1},"end":{"line":27,"column":1}},"key":"bQW7BBUQE9"}],"identifier":"overview","label":"Overview","html_id":"overview","implicit":true,"key":"j76u2AtLFg"},{"type":"paragraph","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"children":[{"type":"text","value":"In this notebook, I’ll show you how to make a simple query on Craigslist using some nifty python modules. You can take advantage of all the structure data that exists on webpages to collect interesting datasets.","position":{"start":{"line":28,"column":1},"end":{"line":28,"column":1}},"key":"ob1RrRArZS"}],"key":"v7Vu1agR7Y"}],"key":"xBqaKEBqOl"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"import pandas as pd\nfrom bs4 import BeautifulSoup as bs4\n%pylab inline","key":"nqT89WnH0U"},{"type":"output","id":"jQeWEppsU-7DvZ2HShNAG","data":[],"key":"unCAA0hWG2"}],"key":"UsKkvfXlGU"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"First we need to figure out how to submit a query to Craigslist. As with many websites, one way you can do this is simply by constructing the proper URL and sending it to Craigslist. Here’s a sample URL that is returned after manually typing in a search to Craigslist:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"rqKtjr6H2V"}],"key":"zxYmfXW0qO"},{"type":"blockquote","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"inlineCode","value":"http://sfbay.craigslist.org/search/eby/apa?bedrooms=1&pets_cat=1&pets_dog=1&is_furnished=1","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"kzNk4oG9Qb"}],"key":"WRyociv9Ja"}],"key":"AwgyQpkxlo"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"This is actually two separate things. The first tells craigslist what kind of thing we’re searching for:","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"LZbUu4GWaf"}],"key":"jYUZqkgulg"},{"type":"blockquote","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"inlineCode","value":"http://sfbay.craigslist.org/search/eby/apa","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"gGJgVCAisY"},{"type":"text","value":" says we’re searching in the sfbay area (","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"ORHD3i98TU"},{"type":"inlineCode","value":"sfbay","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"bL6z4DjIVi"},{"type":"text","value":") for apartments (","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"Ynu0RCK83b"},{"type":"inlineCode","value":"apa","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"AtywsnyRM4"},{"type":"text","value":") in the east bay (","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"m9cCqRpAvt"},{"type":"inlineCode","value":"eby","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"ndPdOM5smT"},{"type":"text","value":").","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"XeRaHOt5qo"}],"key":"y8iIEDpBl7"}],"key":"oMQ6Y9TQCo"},{"type":"paragraph","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"The second part contains the parameters that we pass to the search:","position":{"start":{"line":8,"column":1},"end":{"line":8,"column":1}},"key":"wsTOwc9Rsn"}],"key":"pZ7UOZgV2U"},{"type":"blockquote","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"paragraph","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"children":[{"type":"inlineCode","value":"?bedrooms=1&pets_cat=1&pets_dog=1&is_furnished=1","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"j53KUH6lbI"},{"type":"text","value":" says we want 1+ bedrooms, cats allowed, dogs allowed, and furnished apartments. You can manually change these fields in order to create new queries.","position":{"start":{"line":10,"column":1},"end":{"line":10,"column":1}},"key":"Lj8Dbo4q64"}],"key":"xPNbdqdmJw"}],"key":"Ph7Koxj1gR"},{"type":"heading","depth":2,"position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"children":[{"type":"text","value":"Getting a single posting","position":{"start":{"line":12,"column":1},"end":{"line":12,"column":1}},"key":"CqhreIy3CN"}],"identifier":"getting-a-single-posting","label":"Getting a single posting","html_id":"getting-a-single-posting","implicit":true,"key":"JHehDPmccH"},{"type":"paragraph","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"children":[{"type":"text","value":"So, we’ll use this knowledge to send some custom URLs to Craigslist. We’ll do this using the ","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"VBzM0pZhY8"},{"type":"inlineCode","value":"requests","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"UN5PA2oDSy"},{"type":"text","value":" python module, which is really useful for querying websites.","position":{"start":{"line":14,"column":1},"end":{"line":14,"column":1}},"key":"n84CCxO1cF"}],"key":"n9hCxWqsvi"}],"key":"LvkQUWwPcT"},{"type":"block","kind":"notebook-code","data":{"collapsed":true,"jupyter":{"outputs_hidden":true}},"children":[{"type":"code","lang":"python","executable":true,"value":"import requests","key":"gJa5mgemjK"},{"type":"output","id":"DIpBhTkYtTQQEAMHk06yU","data":[],"key":"kZWjLBLnN9"}],"key":"tkERDNQJOg"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"In internet lingo, we’re posting a ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"uASWAtrl70"},{"type":"inlineCode","value":"get","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Ljap89CANZ"},{"type":"text","value":" requests to the website, which simply says that we’d like to get some information from the Craigslist website.  With requests, we can easily create a dictionary that specifies parameters in the URL:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"LEiJZ5PxnM"}],"key":"p6RdKhe6mO"}],"key":"wuekdqizon"},{"type":"block","kind":"notebook-code","data":{"collapsed":true,"jupyter":{"outputs_hidden":true}},"children":[{"type":"code","lang":"python","executable":true,"value":"url_base = 'http://sfbay.craigslist.org/search/eby/apa'\nparams = dict(bedrooms=1, is_furnished=1)\nrsp = requests.get(url_base, params=params)","key":"HDlxTgTmHu"},{"type":"output","id":"fdE2bJEUogS5j1T96u_DY","data":[],"key":"GIAu6NyYTG"}],"key":"sVzc45fGr9"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"# Note that requests automatically created the right URL:\nprint(rsp.url)","key":"KgClyCaxqc"},{"type":"output","id":"bdOKxo4HFv4CRK6Tdo9bE","data":[],"key":"TCRtwvEKnj"}],"key":"OZhnXsslAz"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"# We can access the content of the response that Craigslist sent back here:\nprint(rsp.text[:500])","key":"cutxx2kUJ0"},{"type":"output","id":"h3uaVktqFMDHyMt-Gf8Ac","data":[],"key":"KZpifeBL1L"}],"key":"vFCGMKd3IX"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Wow, that’s a lot of code. Remember, websites serve HTML documents, and usually your browser will automatically render this into a nice webpage for you. Since we’re doing this with python, we get back the raw text. This is really useful, but how can we possibly parse it all?","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"GESkfroZiu"}],"key":"y5BBsVkRA8"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"For this, we’ll turn to another great package, BeautifulSoup:","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"utHcfjSbSM"}],"key":"KjeC5EyEuY"}],"key":"EhzpBNTTE2"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"# BS4 can quickly parse our text, make sure to tell it that you're giving html\nhtml = bs4(rsp.text, 'html.parser')\n\n# BS makes it easy to look through a document\nprint(html.prettify()[:1000])","key":"rg4hZMyfnI"},{"type":"output","id":"FVTvk6EJ-4Z2KadFjMo5X","data":[],"key":"Db2K2OooBA"}],"key":"WlZT6JIUMV"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Beautiful soup lets us quickly search through an HTML document. We can pull out whatever information we want.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"AeuhqTPqQ9"}],"key":"cytdN9VFH7"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Scanning through this text, we see a common structure repeated ","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"NkbzoiQz4I"},{"type":"inlineCode","value":"<p class=\"row\">","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"uuNmSVnLa3"},{"type":"text","value":". This seems to be the container that has information for a single apartment.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"ixt88fjbId"}],"key":"SdL1IN4eSc"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"In BeautifulSoup, we can quickly get all instances of this container:","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"SWN2WPKjaB"}],"key":"g4Ib2GI6f7"}],"key":"UOesBGTWST"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"# find_all will pull entries that fit your search criteria.\n# Note that we have to use brackets to define the `attrs` dictionary\n# Because \"class\" is a special word in python, so we need to give a string.\napts = html.find_all('p', attrs={'class': 'row'})\nprint(len(apts))","key":"kt4gkXcoZD"},{"type":"output","id":"OJDbWNrEAw8dtonJF565z","data":[],"key":"gP82102Ybk"}],"key":"G01ZhgyxG9"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now let’s look inside the values of a single apartment listing:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RmcyI1EPfe"}],"key":"BLgMM0q7S2"}],"key":"ZSQcaq8eTJ"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"# We can see that there's a consistent structure to a listing.\n# There is a 'time', a 'name', a 'housing' field with size/n_brs, etc.\nthis_appt = apts[15]\nprint(this_appt.prettify())","key":"JTqD73Ew6g"},{"type":"output","id":"GqWwrFAREEazVOjXJCeX8","data":[{"ename":"IndexError","evalue":"list index out of range","output_type":"error","traceback":"\u001b[0;31m---------------------------------------------------------------------------\u001b[0m\n\u001b[0;31mIndexError\u001b[0m                                Traceback (most recent call last)\n\u001b[0;32m<ipython-input-8-b82880a42248>\u001b[0m in \u001b[0;36m<module>\u001b[0;34m()\u001b[0m\n\u001b[1;32m      1\u001b[0m \u001b[0;31m# We can see that there's a consistent structure to a listing.\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m      2\u001b[0m \u001b[0;31m# There is a 'time', a 'name', a 'housing' field with size/n_brs, etc.\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m----> 3\u001b[0;31m \u001b[0mthis_appt\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mapts\u001b[0m\u001b[0;34m[\u001b[0m\u001b[0;36m15\u001b[0m\u001b[0;34m]\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m      4\u001b[0m \u001b[0;32mprint\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mthis_appt\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mprettify\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\n\u001b[0;31mIndexError\u001b[0m: list index out of range"}],"key":"zhNaCiqoFP"}],"key":"dytQ2Cyc9K"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"# So now we'll pull out a couple of things we might be interested in:\n# It looks like \"housing\" contains size information. We'll pull that.\n# Note that `findAll` returns a list, since there's only one entry in\n# this HTML, we'll just pull the first item.\nsize = this_appt.findAll(attrs={'class': 'housing'})[0].text\nprint(size)","key":"fGOAZva3kg"},{"type":"output","id":"Nj3brNHsF_Lr0lRns9kHW","data":[{"ename":"NameError","evalue":"name 'this_appt' is not defined","output_type":"error","traceback":"\u001b[0;31m---------------------------------------------------------------------------\u001b[0m\n\u001b[0;31mNameError\u001b[0m                                 Traceback (most recent call last)\n\u001b[0;32m<ipython-input-9-4fb8a04b88f7>\u001b[0m in \u001b[0;36m<module>\u001b[0;34m()\u001b[0m\n\u001b[1;32m      3\u001b[0m \u001b[0;31m# Note that `findAll` returns a list, since there's only one entry in\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m      4\u001b[0m \u001b[0;31m# this HTML, we'll just pull the first item.\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m----> 5\u001b[0;31m \u001b[0msize\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mthis_appt\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mfindAll\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mattrs\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;34m{\u001b[0m\u001b[0;34m'class'\u001b[0m\u001b[0;34m:\u001b[0m \u001b[0;34m'housing'\u001b[0m\u001b[0;34m}\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m[\u001b[0m\u001b[0;36m0\u001b[0m\u001b[0;34m]\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mtext\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m      6\u001b[0m \u001b[0;32mprint\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0msize\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\n\u001b[0;31mNameError\u001b[0m: name 'this_appt' is not defined"}],"key":"RKBdF0ZIqX"}],"key":"q5NcI0fUUs"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We can query split this into n_bedrooms and the size. However, note that sometimes one of these features might be missing. So we’ll use an ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"f6eiqw1qgC"},{"type":"inlineCode","value":"if","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"euuz7m5twq"},{"type":"text","value":" statement to try and capture this variability:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ozjaBY0q2s"}],"key":"ozZ0qQW3mu"}],"key":"EFdhYqbQF8"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"def find_size_and_brs(size):\n    split = size.strip('/- ').split(' - ')\n    if len(split) == 2:\n        n_brs = split[0].replace('br', '')\n        this_size = split[1].replace('ft2', '')\n    elif 'br' in split[0]:\n        # It's the n_bedrooms\n        n_brs = split[0].replace('br', '')\n        this_size = np.nan\n    elif 'ft2' in split[0]:\n        # It's the size\n        this_size = split[0].replace('ft2', '')\n        n_brs = np.nan\n    return float(this_size), float(n_brs)\nthis_size, n_brs = find_size_and_brs(size)","key":"ra9d6gHASo"},{"type":"output","id":"4dF2KvT9VExVC8Wog5sMq","data":[{"ename":"AttributeError","evalue":"'function' object has no attribute 'strip'","output_type":"error","traceback":"\u001b[0;31m---------------------------------------------------------------------------\u001b[0m\n\u001b[0;31mAttributeError\u001b[0m                            Traceback (most recent call last)\n\u001b[0;32m<ipython-input-10-56ab1d345ab4>\u001b[0m in \u001b[0;36m<module>\u001b[0;34m()\u001b[0m\n\u001b[1;32m     13\u001b[0m         \u001b[0mn_brs\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mnp\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mnan\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     14\u001b[0m     \u001b[0;32mreturn\u001b[0m \u001b[0mfloat\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mthis_size\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mfloat\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mn_brs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m---> 15\u001b[0;31m \u001b[0mthis_size\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mn_brs\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mfind_size_and_brs\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0msize\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\n\u001b[0;32m<ipython-input-10-56ab1d345ab4>\u001b[0m in \u001b[0;36mfind_size_and_brs\u001b[0;34m(size)\u001b[0m\n\u001b[1;32m      1\u001b[0m \u001b[0;32mdef\u001b[0m \u001b[0mfind_size_and_brs\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0msize\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m----> 2\u001b[0;31m     \u001b[0msplit\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0msize\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mstrip\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m'/- '\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0msplit\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m' - '\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m      3\u001b[0m     \u001b[0;32mif\u001b[0m \u001b[0mlen\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0msplit\u001b[0m\u001b[0;34m)\u001b[0m \u001b[0;34m==\u001b[0m \u001b[0;36m2\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m      4\u001b[0m         \u001b[0mn_brs\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0msplit\u001b[0m\u001b[0;34m[\u001b[0m\u001b[0;36m0\u001b[0m\u001b[0;34m]\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mreplace\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m'br'\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m''\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m      5\u001b[0m         \u001b[0mthis_size\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0msplit\u001b[0m\u001b[0;34m[\u001b[0m\u001b[0;36m1\u001b[0m\u001b[0;34m]\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mreplace\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m'ft2'\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m''\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\n\u001b[0;31mAttributeError\u001b[0m: 'function' object has no attribute 'strip'"}],"key":"EUF8KCtLOP"}],"key":"XWlbgSrRnp"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"# Now we'll also pull a few other things:\nthis_time = this_appt.find('time')['datetime']\nthis_time = pd.to_datetime(this_time)\nthis_price = float(this_appt.find('span', {'class': 'price'}).text.strip('$'))\nthis_title = this_appt.find('a', attrs={'class': 'hdrlnk'}).text","key":"tAKLkpU6Q6"},{"type":"output","id":"Xr0sg44_yXArGdzm2A0wF","data":[{"ename":"NameError","evalue":"name 'this_appt' is not defined","output_type":"error","traceback":"\u001b[0;31m---------------------------------------------------------------------------\u001b[0m\n\u001b[0;31mNameError\u001b[0m                                 Traceback (most recent call last)\n\u001b[0;32m<ipython-input-11-bc17374a1087>\u001b[0m in \u001b[0;36m<module>\u001b[0;34m()\u001b[0m\n\u001b[1;32m      1\u001b[0m \u001b[0;31m# Now we'll also pull a few other things:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m----> 2\u001b[0;31m \u001b[0mthis_time\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mthis_appt\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mfind\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m'time'\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m[\u001b[0m\u001b[0;34m'datetime'\u001b[0m\u001b[0;34m]\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m      3\u001b[0m \u001b[0mthis_time\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mpd\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mto_datetime\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mthis_time\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m      4\u001b[0m \u001b[0mthis_price\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mfloat\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mthis_appt\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mfind\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m'span'\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m{\u001b[0m\u001b[0;34m'class'\u001b[0m\u001b[0;34m:\u001b[0m \u001b[0;34m'price'\u001b[0m\u001b[0;34m}\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mtext\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mstrip\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m'$'\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m      5\u001b[0m \u001b[0mthis_title\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mthis_appt\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mfind\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m'a'\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mattrs\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0;34m{\u001b[0m\u001b[0;34m'class'\u001b[0m\u001b[0;34m:\u001b[0m \u001b[0;34m'hdrlnk'\u001b[0m\u001b[0;34m}\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mtext\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\n\u001b[0;31mNameError\u001b[0m: name 'this_appt' is not defined"}],"key":"lr29Y87HMI"}],"key":"nCDU2zDsVH"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"# Now we've got the n_bedrooms, size, price, and time of listing\nprint('\\n'.join([str(i) for i in [this_size, n_brs, this_time, this_price, this_title]]))","key":"gVdwFt0Nhk"},{"type":"output","id":"WfmjNd4yGkjKCfI_V_2QS","data":[{"ename":"NameError","evalue":"name 'this_size' is not defined","output_type":"error","traceback":"\u001b[0;31m---------------------------------------------------------------------------\u001b[0m\n\u001b[0;31mNameError\u001b[0m                                 Traceback (most recent call last)\n\u001b[0;32m<ipython-input-12-6b0491d04915>\u001b[0m in \u001b[0;36m<module>\u001b[0;34m()\u001b[0m\n\u001b[1;32m      1\u001b[0m \u001b[0;31m# Now we've got the n_bedrooms, size, price, and time of listing\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m----> 2\u001b[0;31m \u001b[0;32mprint\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m'\\n'\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mjoin\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m[\u001b[0m\u001b[0mstr\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mi\u001b[0m\u001b[0;34m)\u001b[0m \u001b[0;32mfor\u001b[0m \u001b[0mi\u001b[0m \u001b[0;32min\u001b[0m \u001b[0;34m[\u001b[0m\u001b[0mthis_size\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mn_brs\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mthis_time\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mthis_price\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mthis_title\u001b[0m\u001b[0;34m]\u001b[0m\u001b[0;34m]\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\n\u001b[0;31mNameError\u001b[0m: name 'this_size' is not defined"}],"key":"uwo8SHzCCM"}],"key":"YuCouOI554"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Querying lots of postings","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"BiiWeAg6Bn"}],"identifier":"querying-lots-of-postings","label":"Querying lots of postings","html_id":"querying-lots-of-postings","implicit":true,"key":"p87OGMvGVp"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Cool - so now we’ve got some useful information about one listing. Now let’s loop through many listings across several locations.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"X7jJgyVbIO"}],"key":"orZGYQP44X"},{"type":"paragraph","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"It looks like there is a “city code” that distinguishes where you’re searching. Here is a ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"qpNpejc8dp"},{"type":"strong","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"not","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"WSRSnSKOrk"}],"key":"cE1m1piF6I"},{"type":"text","value":" up to date list: ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"urSohljBUd"},{"type":"link","url":"https://sites.google.com/site/clsiteinfo/city-site-code-sort","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"link","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"J75q3Zg4iV"}],"urlSource":"https://sites.google.com/site/clsiteinfo/city-site-code-sort","key":"Bvs9gYq5jn"}],"key":"NumA3mj3PN"},{"type":"paragraph","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"children":[{"type":"text","value":"Within the Bay Area, there are also a lot of sub-regional locations, which we’ll define here, then loop through them all.","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"W8i6wy6TrQ"}],"key":"DD8BbNPOsZ"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Note that the ","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"X7PB2yNpI7"},{"type":"inlineCode","value":"s","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"YXTrEaauXr"},{"type":"text","value":" parameter tells Craiglist where to start in terms of the number of results given back. E.g., if s==100, then it starts at the 100th entry.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"Dq7kgnlvL4"}],"key":"GJAtAONYYt"}],"key":"b6vN78TQ4l"},{"type":"block","kind":"notebook-code","data":{"collapsed":true,"jupyter":{"outputs_hidden":true}},"children":[{"type":"code","lang":"python","executable":true,"value":"loc_prefixes = ['eby', 'nby', 'sfc', 'sby', 'scz']","key":"FCTaFqabDt"},{"type":"output","id":"jESkB5OXrUyGrIvBy8gwY","data":[],"key":"yzp81GXupv"}],"key":"dAZMLSMz9h"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We’ll define a few helper functions to handle edge cases and make sure that we don’t get any errors.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"SXPzrYHNy8"}],"key":"udX3CZEGMG"}],"key":"o2SbFkJU6U"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"def find_prices(results):\n    prices = []\n    for rw in results:\n        price = rw.find('span', attrs={'class': 'result-price'})\n        if price is not None:\n            price = float(price.text.strip('$'))\n        else:\n            price = np.nan\n        prices.append(price)\n    return prices\n\ndef find_times(results):\n    times = []\n    for rw in apts:\n        if time is not None:\n            time = time['datetime']\n            time = pd.to_datetime(time)\n        else:\n            time = np.nan\n        times.append(time)\n    return times","key":"p82oQ0CfGI"},{"type":"output","id":"L5LxBlCcebi-RUCvHGM2b","data":[],"key":"Kif6zFNCkp"}],"key":"zedQ8JPZOU"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Now we’re ready to go. We’ll loop through all of our locations, and pull a number of entries for each one. We’ll use a pandas dataframe to store everything, because this will be useful for future analysis.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"TPuqxrw5v1"}],"key":"UarrPoHfp7"},{"type":"paragraph","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"strong","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"children":[{"type":"text","value":"Note","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"vtSnRVsMz9"}],"key":"gdQEAkg64M"},{"type":"text","value":" - Craigslist won’t take kindly to you querying their server a bunch of times at once. Make sure not to pull too much data too quickly. Another option is to add a delay to each loop iteration. Otherwise your IP might get banned.","position":{"start":{"line":3,"column":1},"end":{"line":3,"column":1}},"key":"XrMMzDgLxJ"}],"key":"DE8P2EzLK2"}],"key":"vRcuDlxX6T"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"print(txt.prettify())","key":"nVx6Uuuunk"},{"type":"output","id":"k59Ehzqcs-ZUZ-oNblid3","data":[{"ename":"NameError","evalue":"name 'txt' is not defined","output_type":"error","traceback":"\u001b[0;31m---------------------------------------------------------------------------\u001b[0m\n\u001b[0;31mNameError\u001b[0m                                 Traceback (most recent call last)\n\u001b[0;32m<ipython-input-9-97e76ea257b9>\u001b[0m in \u001b[0;36m<module>\u001b[0;34m()\u001b[0m\n\u001b[0;32m----> 1\u001b[0;31m \u001b[0;32mprint\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mtxt\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mprettify\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\n\u001b[0;31mNameError\u001b[0m: name 'txt' is not defined"}],"key":"TX1wB6vSMR"}],"key":"JpvQDn1hTF"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"def find_size_and_brs(size):\n    split = size.strip().split('\\n')\n    split = [ii.strip().strip(' -') for ii in split]\n    if len(split) == 2:\n        n_brs = split[0].replace('br', '')\n        this_size = split[1].replace('ft2', '')\n    elif 'br' in split[0]:\n        # It's the n_bedrooms\n        n_brs = split[0].replace('br', '')\n        this_size = np.nan\n    elif 'ft2' in split[0]:\n        # It's the size\n        this_size = split[0].replace('ft2', '')\n        n_brs = np.nan\n    return float(this_size), float(n_brs)","key":"Hp5LJrJzyL"},{"type":"output","id":"VbVQd1RxKo6kUxEOc8yZi","data":[],"key":"M7ZK1hFIwq"}],"key":"gYsfTXfyvg"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"# Now loop through all of this and store the results\nresults = []  # We'll store the data here\n# Careful with this...too many queries == your IP gets banned temporarily\nsearch_indices = np.arange(0, 500, 100)\nloc_prefixes = ['eby']\nfor loc in loc_prefixes:\n    print loc\n    for i in search_indices:\n        url = 'http://sfbay.craigslist.org/search/{0}/apa'.format(loc)\n        resp = requests.get(url, params={'bedrooms': 1, 's': i})\n        txt = bs4(resp.text, 'html.parser')\n        apts = txt.findAll(attrs={'class': \"result-info\"})\n\n        # Find the size of all entries\n        size_text = [rw.findAll(attrs={'class': 'housing'})[0].text\n                     for rw in apts]\n        sizes_brs = [find_size_and_brs(stxt) for stxt in size_text]\n        sizes, n_brs = zip(*sizes_brs)  # This unzips into 2 vectors\n\n        # Find the title and link\n        title = [rw.find('a', attrs={'class': 'hdrlnk'}).text\n                      for rw in apts]\n        links = [rw.find('a', attrs={'class': 'hdrlnk'})['href']\n                 for rw in apts]\n\n        # Find the time\n        time = [pd.to_datetime(rw.find('time')['datetime']) for rw in apts]\n        price = find_prices(apts)\n\n        # We'll create a dataframe to store all the data\n        data = np.array([time, price, sizes, n_brs, title, links])\n        col_names = ['time', 'price', 'size', 'brs', 'title', 'link']\n        df = pd.DataFrame(data.T, columns=col_names)\n        df = df.set_index('time')\n\n        # Add the location variable to all entries\n        df['loc'] = loc\n        results.append(df)\n        \n# Finally, concatenate all the results\nresults = pd.concat(results, axis=0)","key":"gDpIPUkFIJ"},{"type":"output","id":"BID28EG9-m1w6BAL_cbS9","data":[],"key":"HEEIf7Pxge"}],"key":"znVLEGRjYN"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"def seconds_to_days(seconds):\n    return seconds / 60. / 60. / 24.\n\n# We'll make sure that the right columns are represented numerically:\nresults[['price', 'size', 'brs']] = results[['price', 'size', 'brs']].convert_objects(convert_numeric=True)\nresults.index.name = 'time'\n\n# Add the age of each result\nnow = pd.datetime.utcnow()\nresults['age'] = [1. / seconds_to_days((now - ii).total_seconds())\n                  for ii in results.index]","key":"E8q1H9T1Ra"},{"type":"output","id":"_pzASTIdWbrgy7rx_nZKP","data":[],"key":"aWnB24lrHC"}],"key":"so8tx4UTZT"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"# And there you have it:\nresults.head()","key":"M7wJTxBcHb"},{"type":"output","id":"5lwvLlaNnPjo8PU5B-AKZ","data":[{"output_type":"execute_result","execution_count":13,"metadata":{},"data":{"text/html":{"content":"<div>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>price</th>\n      <th>size</th>\n      <th>brs</th>\n      <th>title</th>\n      <th>link</th>\n      <th>loc</th>\n      <th>age</th>\n    </tr>\n    <tr>\n      <th>time</th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n      <th></th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>2016-11-17 09:12:00</th>\n      <td>2450.0</td>\n      <td>850.0</td>\n      <td>3.0</td>\n      <td>APARTMENT 3 BR/ 1 BT</td>\n      <td>/eby/apa/5873549022.html</td>\n      <td>eby</td>\n      <td>2.952374</td>\n    </tr>\n    <tr>\n      <th>2016-11-17 09:12:00</th>\n      <td>2005.0</td>\n      <td>790.0</td>\n      <td>1.0</td>\n      <td>Perfect Cozy One-Bedroom Available Now! Only $...</td>\n      <td>/eby/apa/5880750933.html</td>\n      <td>eby</td>\n      <td>2.952374</td>\n    </tr>\n    <tr>\n      <th>2016-11-17 09:12:00</th>\n      <td>1875.0</td>\n      <td>NaN</td>\n      <td>1.0</td>\n      <td>FANTASTIC PLACE - Lovely Yard!</td>\n      <td>/eby/apa/5870868630.html</td>\n      <td>eby</td>\n      <td>2.952374</td>\n    </tr>\n    <tr>\n      <th>2016-11-17 09:11:00</th>\n      <td>1525.0</td>\n      <td>650.0</td>\n      <td>1.0</td>\n      <td>Large 1 bedroom Washer/Dryer</td>\n      <td>/eby/apa/5865407315.html</td>\n      <td>eby</td>\n      <td>2.946333</td>\n    </tr>\n    <tr>\n      <th>2016-11-17 09:11:00</th>\n      <td>6000.0</td>\n      <td>NaN</td>\n      <td>3.0</td>\n      <td>3BR/2.5BA Home Panoramic Views (90 Skyway Lane)</td>\n      <td>/eby/apa/5880673685.html</td>\n      <td>eby</td>\n      <td>2.946333</td>\n    </tr>\n  </tbody>\n</table>\n</div>","content_type":"text/html"},"text/plain":{"content":"                      price   size  brs  \\\ntime                                      \n2016-11-17 09:12:00  2450.0  850.0  3.0   \n2016-11-17 09:12:00  2005.0  790.0  1.0   \n2016-11-17 09:12:00  1875.0    NaN  1.0   \n2016-11-17 09:11:00  1525.0  650.0  1.0   \n2016-11-17 09:11:00  6000.0    NaN  3.0   \n\n                                                                 title  \\\ntime                                                                     \n2016-11-17 09:12:00                               APARTMENT 3 BR/ 1 BT   \n2016-11-17 09:12:00  Perfect Cozy One-Bedroom Available Now! Only $...   \n2016-11-17 09:12:00                     FANTASTIC PLACE - Lovely Yard!   \n2016-11-17 09:11:00                       Large 1 bedroom Washer/Dryer   \n2016-11-17 09:11:00    3BR/2.5BA Home Panoramic Views (90 Skyway Lane)   \n\n                                         link  loc       age  \ntime                                                          \n2016-11-17 09:12:00  /eby/apa/5873549022.html  eby  2.952374  \n2016-11-17 09:12:00  /eby/apa/5880750933.html  eby  2.952374  \n2016-11-17 09:12:00  /eby/apa/5870868630.html  eby  2.952374  \n2016-11-17 09:11:00  /eby/apa/5865407315.html  eby  2.946333  \n2016-11-17 09:11:00  /eby/apa/5880673685.html  eby  2.946333  ","content_type":"text/plain"}}}],"key":"EZlLdcCTui"}],"key":"JiNYAFWRkp"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"ax = results.hist('price', bins=np.arange(0, 10000, 100))[0, 0]\nax.set_title('Mother of god.', fontsize=20)\nax.set_xlabel('Price', fontsize=18)\nax.set_ylabel('Count', fontsize=18)","key":"gE42sRTqpd"},{"type":"output","id":"rMHGmi0Epsd7672O88XNi","data":[{"output_type":"execute_result","execution_count":14,"metadata":{},"data":{}},{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"0d3cf0bc7c15d7a116cf313e8401420b","path":"/build/0d3cf0bc7c15d7a116cf313e8401420b.png"}}}],"key":"pjNdf7mKYz"}],"key":"DUIoTaOWmt"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"target_price = 2200.\ntarget_size = 1400.\nhighlight = pd.DataFrame([[target_price, target_size, 2, 'eby', 'Mine', 'None', 1, results['age'].max()]],\n                         columns=['price', 'size', 'brs', 'loc', 'title', 'link', 'mine', 'age'])\nresults['mine'] = 0\nresults = results.append(highlight)","key":"kTtltdnATP"},{"type":"output","id":"FZUKwNxgdLjxvNFKlyXML","data":[],"key":"C9aLwjlaiN"}],"key":"Aptmz99G4e"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"import altair\ngraph = altair.Chart(results)\ngraph.mark_circle(size=200).encode(x='size', y='price',\n                                   color='mine:N')","key":"xHNPTnvO6e"},{"type":"output","id":"sITVzU-3PaQaDlfQ23MkL","data":[{"output_type":"display_data","metadata":{"jupyter-vega":"#b5c5d25b-82b9-48b4-b4c5-5596b3e90154"},"data":{"text/html":{"content":"<div class=\"vega-embed\" id=\"b5c5d25b-82b9-48b4-b4c5-5596b3e90154\"></div>\n\n<style>\n.vega-embed svg, .vega-embed canvas {\n  border: 1px dotted gray;\n}\n\n.vega-embed .vega-actions a {\n  margin-right: 6px;\n}\n</style>\n","content_type":"text/html"}}},{"output_type":"display_data","metadata":{"jupyter-vega":"#b5c5d25b-82b9-48b4-b4c5-5596b3e90154"},"data":{"application/javascript":{"content_type":"application/javascript","hash":"fa8f1d462c53af89f536d75ede0fd51b","path":"/build/fa8f1d462c53af89f536d75ede0fd51b.json"}}},{"output_type":"display_data","metadata":{"jupyter-vega":"#b5c5d25b-82b9-48b4-b4c5-5596b3e90154"},"data":{"image/png":{"content_type":"image/png","hash":"13a148611e764563fb2a9d4fae404097","path":"/build/13a148611e764563fb2a9d4fae404097.png"}}}],"key":"EURPtHiZuh"}],"key":"yCIso3W382"},{"type":"block","kind":"notebook-code","data":{"collapsed":false,"jupyter":{"outputs_hidden":false}},"children":[{"type":"code","lang":"python","executable":true,"value":"smin, smax = (1300, 1500)\nn_br = 2\n# subset = results.query('size > @smin and size < @smax')\nfig, ax = plt.subplots()\nresults.query('brs < 4').groupby('brs').hist('price', bins=np.arange(0, 5000, 200), ax=ax)\nax.axvline(target_price, c='r', ls='--')\n","key":"PWawir0aaZ"},{"type":"output","id":"XRFYdF0aKY0bZ5y6qJi0l","data":[{"output_type":"execute_result","execution_count":17,"metadata":{},"data":{}},{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"1b46d45beec910ba560e8c82a965ac0c","path":"/build/1b46d45beec910ba560e8c82a965ac0c.png"}}}],"key":"bIfhN81CCJ"}],"key":"LQ6KpZ13R2"},{"type":"block","kind":"notebook-code","data":{"collapsed":true,"jupyter":{"outputs_hidden":true}},"children":[{"type":"code","lang":"python","executable":true,"value":"# Finally, we can save this data to a CSV to play around with it later.\n# We'll have to remove some annoying characters first:\nimport string\nuse_chars = string.ascii_letters +\\\n    ''.join([str(i) for i in range(10)]) +\\\n    ' /\\.'\nresults['title'] = results['title'].apply(\n    lambda a: ''.join([i for i in a if i in use_chars]))\n\nresults.to_csv('../data/craigslist_results.csv')","key":"GsnXWmYGR6"},{"type":"output","id":"O-BYQNv6WC6r-WKkaGqxj","data":[],"key":"SOYD7jNXFC"}],"key":"mUi178piM9"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"RECAP","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"XOTvalMPDr"}],"identifier":"recap","label":"RECAP","html_id":"recap","implicit":true,"key":"LZtl7hxy8K"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"To sum up what we just did:","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"AoJQh6yUpq"}],"key":"q8G0fxkfmr"},{"type":"list","ordered":false,"spread":false,"position":{"start":{"line":4,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"listItem","spread":true,"position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"We defined the ability to query a website using a custom URL. This is usually the same in structure for website, but the parameter names will be different.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"qtq2149qdd"}],"key":"TmOtVHzN2c"},{"type":"listItem","spread":true,"position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"We sent a ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"IqIQa6icat"},{"type":"inlineCode","value":"get","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"R36cqsrcn1"},{"type":"text","value":" request to Craigslist using the ","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"skGmRyJitI"},{"type":"inlineCode","value":"requests","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"CohBltEomd"},{"type":"text","value":" module of python.","position":{"start":{"line":5,"column":1},"end":{"line":5,"column":1}},"key":"zA4FbfiRnm"}],"key":"U58ZxzPvML"},{"type":"listItem","spread":true,"position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"children":[{"type":"text","value":"We parsed the response using ","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"oeQsxn8kIv"},{"type":"inlineCode","value":"BeautifulSoup4","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"oBX0xkXaSp"},{"type":"text","value":".","position":{"start":{"line":6,"column":1},"end":{"line":6,"column":1}},"key":"g1mBQrPPln"}],"key":"EzDuz9Jkgk"},{"type":"listItem","spread":true,"position":{"start":{"line":7,"column":1},"end":{"line":8,"column":1}},"children":[{"type":"text","value":"We then looped through a bunch of apartment listings, pulled some relevant data, and combined it all into a cleaned and usable dataframe with ","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"Rp9N7FFDlN"},{"type":"inlineCode","value":"pandas","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"fZY5MWsH08"},{"type":"text","value":".","position":{"start":{"line":7,"column":1},"end":{"line":7,"column":1}},"key":"k3jTz7R01Y"}],"key":"YG3v9szHtv"}],"key":"GLipb2y7IX"},{"type":"paragraph","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"children":[{"type":"text","value":"Next up I’ll take a look at the data, and see if there’s anything interesting to make of it.","position":{"start":{"line":9,"column":1},"end":{"line":9,"column":1}},"key":"xA6Q7Rqc0S"}],"key":"LcLDIf8mjd"}],"key":"EijOBEK7DD"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Bonus - auto-emailing yourself w/ notifications","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"kErnjPg4jd"}],"identifier":"bonus-auto-emailing-yourself-w-notifications","label":"Bonus - auto-emailing yourself w/ notifications","html_id":"bonus-auto-emailing-yourself-w-notifications","implicit":true,"key":"riL9Tpx3E9"},{"type":"paragraph","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"A few people have asked me about using this kind of process to make a bot that scrapes craigslist periodically. This is actually quite simple, as it basically involves pulling the top listings from craigslist, checking this against an “old” list, and detecting if there’s anything new that has popped up since the last time you checked.","position":{"start":{"line":2,"column":1},"end":{"line":2,"column":1}},"key":"WnvKvRlvbL"}],"key":"uSRjNYZX0c"},{"type":"paragraph","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Here’s a simple script that will get the job done. Once again, don’t pull too much data at once, and don’t query Craigslist too frequently, or you’re gonna get banned.","position":{"start":{"line":4,"column":1},"end":{"line":4,"column":1}},"key":"mU4cmqtIgM"}],"key":"egJdOgUlvP"}],"key":"fBg1I9KePG"},{"type":"block","kind":"notebook-code","data":{"collapsed":true,"jupyter":{"outputs_hidden":true}},"children":[{"type":"code","lang":"python","executable":true,"value":"# We'll use the gmail module (there really is a module for everything in python)\nimport gmail\nimport time","key":"dkboe9cdHM"},{"type":"output","id":"2PJZU-BLxunLV_zJGpFoa","data":[],"key":"DiIPY9je4h"}],"key":"WYDlzLlJQ9"},{"type":"block","kind":"notebook-code","data":{"collapsed":true,"jupyter":{"outputs_hidden":true}},"children":[{"type":"code","lang":"python","executable":true,"value":"gm = gmail.GMail('my_username', 'my_password')\ngm.connect()\n\n# Define our URL and a query we want to post\nbase_url = 'http://sfbay.craigslist.org/'\nurl = base_url + 'search/eby/apa?nh=48&anh=49&nh=112&nh=58&nh=61&nh=62&nh=66&max_price=2200&bedrooms=1'\n\n# This will remove weird characters that people put in titles like ****!***!!!\nuse_chars = string.ascii_letters + ''.join([str(i) for i in range(10)]) + ' '","key":"N7t2wz0JiD"},{"type":"output","id":"At2Qorzq4QMT5bEaC7OWy","data":[{"ename":"SMTPAuthenticationError","evalue":"(535, '5.7.8 Username and Password not accepted. Learn more at\\n5.7.8  https://support.google.com/mail/answer/14257 of1sm4627014pbc.11 - gsmtp')","output_type":"error","traceback":"\u001b[0;31m---------------------------------------------------------------------------\u001b[0m\n\u001b[0;31mSMTPAuthenticationError\u001b[0m                   Traceback (most recent call last)\n\u001b[0;32m<ipython-input-2-49f6a18c0f58>\u001b[0m in \u001b[0;36m<module>\u001b[0;34m()\u001b[0m\n\u001b[1;32m      1\u001b[0m \u001b[0mgm\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mgmail\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mGMail\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m'my_username'\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m'my_password'\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m----> 2\u001b[0;31m \u001b[0mgm\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mconnect\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m      3\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m      4\u001b[0m \u001b[0;31m# Define our URL and a query we want to post\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m      5\u001b[0m \u001b[0mbase_url\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0;34m'http://sfbay.craigslist.org/'\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\n\u001b[0;32m/Users/choldgraf/anaconda/lib/python3.7/site-packages/gmail/gmail.pyc\u001b[0m in \u001b[0;36mconnect\u001b[0;34m(self)\u001b[0m\n\u001b[1;32m     65\u001b[0m         \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0msession\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mehlo\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     66\u001b[0m         \u001b[0;32mtry\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m---> 67\u001b[0;31m             \u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0msession\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mlogin\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0musername\u001b[0m\u001b[0;34m,\u001b[0m\u001b[0mself\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mpassword\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m     68\u001b[0m         \u001b[0;32mexcept\u001b[0m \u001b[0mSMTPAuthenticationError\u001b[0m\u001b[0;34m,\u001b[0m\u001b[0me\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     69\u001b[0m             \u001b[0;31m# Catch redirect to account unlock & reformat\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\n\u001b[0;32m/Users/choldgraf/anaconda/lib/python3.7/smtplib.pyc\u001b[0m in \u001b[0;36mlogin\u001b[0;34m(self, user, password)\u001b[0m\n\u001b[1;32m    620\u001b[0m             \u001b[0;31m# 235 == 'Authentication successful'\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    621\u001b[0m             \u001b[0;31m# 503 == 'Error: already authenticated'\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 622\u001b[0;31m             \u001b[0;32mraise\u001b[0m \u001b[0mSMTPAuthenticationError\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mcode\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mresp\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m    623\u001b[0m         \u001b[0;32mreturn\u001b[0m \u001b[0;34m(\u001b[0m\u001b[0mcode\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mresp\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    624\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n\n\u001b[0;31mSMTPAuthenticationError\u001b[0m: (535, '5.7.8 Username and Password not accepted. Learn more at\\n5.7.8  https://support.google.com/mail/answer/14257 of1sm4627014pbc.11 - gsmtp')"}],"key":"AhPxJVz1NI"}],"key":"IqyfHmQnjT"},{"type":"block","kind":"notebook-code","data":{"collapsed":true,"jupyter":{"outputs_hidden":true}},"children":[{"type":"code","lang":"python","executable":true,"value":"link_list = []  # We'll store the data here\nlink_list_send = []  # This is a list of links to be sent\nsend_list = []  # This is what will actually be sent in the email\n\n# Careful with this...too many queries == your IP gets banned temporarily\nwhile True:\n    resp = requests.get(url)\n    txt = bs4(resp.text, 'html.parser')\n    apts = txt.findAll(attrs={'class': \"row\"})\n    \n    # We're just going to pull the title and link\n    for apt in apts:\n        title = apt.find_all('a', attrs={'class': 'hdrlnk'})[0]\n        name = ''.join([i for i in title.text if i in use_chars])\n        link = title.attrs['href']\n        if link not in link_list and link not in link_list_send:\n            print('Found new listing')\n            link_list_send.append(link)\n            send_list.append(name + '  -  ' + base_url+link)\n            \n    # Flush the cache if we've found new entries\n    if len(link_list_send) > 0:\n        print('Sending mail!')\n        msg = '\\n'.join(send_list)\n        m = email.message.Message()\n        m.set_payload(msg)\n        gm.send(m, ['recipient_email@mydomain.com'])\n        link_list += link_list_send\n        link_list_send = []\n        send_list = []\n    \n    # Sleep a bit so CL doesn't ban us\n    sleep_amt = np.random.randint(60, 120)\n    time.sleep(sleep_amt)","key":"yV2bP12oxR"},{"type":"output","id":"lqZZcYCtc5rEd-OgsyejD","data":[],"key":"VAm4AWPVGq"}],"key":"sLsoy1V6dc"},{"type":"block","kind":"notebook-content","data":{},"children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"And there you have it - your own little bot to keep you on the top of the rental market.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Re1hiQF7Nu"}],"key":"fN98pfosfN"}],"key":"SdCv1E99qQ"}],"key":"unoDzTmvRQ"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Coherence vs. Correlation - a simple simulation","url":"/blog/2015/2015-05-27-coherence-correlation","group":"2015"},"next":{"title":"Craigslist data analysis","url":"/blog/2015/2015-09-27-craigslist-data-analysis","group":"2015"}}},"domain":"http://localhost:3000"}